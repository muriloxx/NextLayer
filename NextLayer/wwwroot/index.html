<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextLayer - Portal</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- INÍCIO DO CSS --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 2rem 0;
        }

        .container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 600px; /* Será ajustado para 900px na tela do dashboard */
            margin-top: 1rem;
            margin-bottom: 1rem;
            transition: max-width 0.3s ease-in-out; /* Adiciona transição suave */
        }

        /* Ajuste para telas de dashboard ficarem mais largas */
        .screen.dashboard-active {
            max-width: 900px;
        }

        .screen {
            display: none;
        }
            /* Esconde todas as telas por padrão */
            .screen.active {
                display: block;
            }
        /* Mostra apenas a tela ativa */
        h2 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 1.5rem;
        }

        h3 {
            margin-top: 1.5rem;
            color: #333;
        }

        .form-group {
            margin-bottom: 1rem;
        }

            .form-group label {
                display: block;
                margin-bottom: 0.5rem;
                color: #555;
                font-weight: 500;
            }

            .form-group input, .form-group textarea, .form-group select {
                width: 100%;
                padding: 0.75rem;
                box-sizing: border-box;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 1rem;
            }

                .form-group input[type="file"] {
                    padding: 0.3rem;
                    border: none;
                }

        .btn {
            width: 100%;
            padding: 0.85rem;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 1rem;
        }

            .btn:hover {
                background-color: #0056b3;
            }

            .btn:disabled {
                background-color: #a0cfff;
                cursor: not-allowed;
            }

        .btn-success {
            background-color: #28a745;
        }

            .btn-success:hover {
                background-color: #218838;
            }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

            .btn-warning:hover {
                background-color: #e0a800;
            }

        .nav-links {
            text-align: center;
            margin-top: 1.5rem;
        }

        .nav-link {
            color: #007bff;
            cursor: pointer;
            margin: 0 0.5rem;
            text-decoration: none;
        }

            .nav-link:hover {
                text-decoration: underline;
            }

        #message-area {
            text-align: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 4px;
            display: none;
            word-wrap: break-word;
        }

            #message-area.success {
                background-color: #d4edda;
                color: #155724;
                display: block;
            }

            #message-area.error {
                background-color: #f8d7da;
                color: #721c24;
                display: block;
            }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

            .header h2 {
                margin: 0;
                padding: 0;
                text-align: left;
                flex-grow: 1;
                font-size: 1.5rem;
            }

                .header h2 .user-name {
                    font-weight: 400;
                    color: #555;
                    font-size: 0.9em;
                    margin-left: 8px;
                }

        .btn-action {
            background: none;
            border: 1px solid #007bff;
            color: #007bff;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 0.5rem;
            flex-shrink: 0;
        }

            .btn-action:hover {
                background-color: #e7f3ff;
            }

        .btn-logout {
            background: none;
            border: 1px solid #dc3545;
            color: #dc3545;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 0.5rem;
            flex-shrink: 0;
        }

            .btn-logout:hover {
                background-color: #f8d7da;
            }

        .btn-back {
            background: none;
            border: 1px solid #6c757d;
            color: #6c757d;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }

            .btn-back:hover {
                background-color: #e9ecef;
            }

        .ticket-grid-container {
            max-height: 400px;
            overflow: auto; /* <-- ALTERAÇÃO RESPONSIVIDADE */
            margin-top: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .ticket-grid {
            width: 100%;
            border-collapse: collapse;
        }

            .ticket-grid th, .ticket-grid td {
                border-bottom: 1px solid #ddd;
                padding: 0.75rem;
                text-align: left;
                vertical-align: top;
            }

            .ticket-grid th {
                background-color: #f9f9f9;
                position: sticky;
                top: 0;
                z-index: 1;
            }

            .ticket-grid tbody tr {
                cursor: default;
            }

                .ticket-grid tbody tr:hover {
                    background-color: #f0f8ff;
                }

        .grid-clickable-cell {
            cursor: pointer;
            text-decoration: underline;
            color: #0056b3;
        }

        /* --- NOVO: Estilos para botões de grid --- */
        .btn-grid-edit, .btn-grid-delete {
            padding: 0.3rem 0.6rem;
            font-size: 0.85rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }

        .btn-grid-edit {
            background-color: #e7f3ff;
            color: #0056b3;
            border-color: #b8d6f3;
        }

            .btn-grid-edit:hover {
                background-color: #cce5ff;
            }

        .btn-grid-delete {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

            .btn-grid-delete:hover {
                background-color: #f1b0b7;
            }

        .btn-grid-cancel {
            width: auto;
            margin-top: 0;
            margin-left: 10px;
            padding: 0.85rem;
            font-size: 1rem;
            background-color: #6c757d;
        }

            .btn-grid-cancel:hover {
                background-color: #5a6268;
            }

        .hidden {
            display: none;
        }
        /* --- FIM NOVO --- */


        .ticket-grid td:last-child, .ticket-grid th:last-child {
            padding-right: 1rem;
        }

        .ticket-grid td:first-child, .ticket-grid th:first-child {
            padding-left: 1rem;
        }

        .status-select {
            padding: 0.3rem 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            font-size: 0.9em;
            cursor: pointer;
        }

            .status-select:disabled {
                background-color: #e9ecef;
                cursor: not-allowed;
                opacity: 0.7;
            }

        #analyst-controls {
            display: none;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            background-color: #f9f9f9;
        }

            #analyst-controls h4 {
                margin-top: 0;
                margin-bottom: 1rem;
                color: #333;
            }

        .analyst-controls-grid {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

            .analyst-controls-grid .form-group {
                flex: 1;
                min-width: 150px;
                margin-bottom: 0.5rem;
            }

        #btn-save-analyst-changes {
            width: auto;
            padding: 0.5rem 1.5rem;
            margin-top: 0.5rem;
            background-color: #28a745;
            border-color: #28a745;
        }

            #btn-save-analyst-changes:hover {
                background-color: #218838;
            }

            #btn-save-analyst-changes:disabled {
                background-color: #94d3a2;
                cursor: not-allowed;
            }

        .chat-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 1.5rem;
        }

        .chat-header {
            background-color: #f9f9f9;
            padding: 1rem;
            border-bottom: 1px solid #ddd;
        }

            .chat-header h4 {
                margin: 0;
                color: #333;
            }

            .chat-header span {
                font-size: 0.9rem;
                color: #666;
                display: block;
                margin-top: 0.2rem;
            }

        .anexos-list {
            padding: 0.5rem 1rem 1rem 1rem;
            border-bottom: 1px solid #eee;
            background-color: #fdfdfd;
        }

            .anexos-list strong {
                font-size: 0.9rem;
                color: #555;
            }

            .anexos-list ul {
                list-style: none;
                padding-left: 0;
                margin: 0.5rem 0 0 0;
            }

            .anexos-list li {
                margin-bottom: 0.3rem;
            }

                .anexos-list li a {
                    text-decoration: none;
                    color: #007bff;
                    font-size: 0.9rem;
                    word-break: break-all;
                }

                    .anexos-list li a:hover {
                        text-decoration: underline;
                    }

        .chat-messages {
            height: 350px;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f5f5f5;
        }

        .chat-input-form {
            display: flex;
            border-top: 1px solid #ddd;
        }

            .chat-input-form input {
                flex-grow: 1;
                border: none;
                padding: 1rem;
                border-radius: 0 0 0 4px;
                outline: none;
                font-size: 1rem;
            }

            .chat-input-form button {
                border: none;
                background-color: #007bff;
                color: white;
                padding: 0 1.5rem;
                cursor: pointer;
                border-radius: 0 0 4px 0;
                font-size: 1rem;
                flex-shrink: 0;
            }

                .chat-input-form button:hover {
                    background-color: #0056b3;
                }

                .chat-input-form button:disabled {
                    background-color: #a0cfff;
                    cursor: not-allowed;
                }

        .chat-message {
            margin-bottom: 1rem;
            max-width: 80%;
            display: flex;
            flex-direction: column;
        }

            .chat-message .sender {
                font-weight: bold;
                font-size: 0.85rem;
                color: #333;
                margin-bottom: 0.2rem;
                display: block;
            }

            .chat-message .timestamp {
                font-size: 0.75rem;
                color: #999;
                margin-left: 0.5rem;
            }

            .chat-message .content {
                padding: 0.75rem;
                border-radius: 8px;
                margin-top: 0.25rem;
                word-wrap: break-word;
                line-height: 1.4;
            }

            .chat-message.other {
                align-items: flex-start;
                margin-right: auto;
            }

                .chat-message.other .sender {
                    text-align: left;
                }

            .chat-message.viewer {
                align-items: flex-end;
                margin-left: auto;
            }

                .chat-message.viewer .sender {
                    text-align: right;
                }

                .chat-message.viewer .content {
                    background-color: #007bff;
                    color: white;
                }

            .chat-message.other.client .content {
                background-color: #e9ecef;
                color: #333;
            }

            .chat-message.other.ia .content {
                background-color: #f8f9fa;
                border: 1px solid #e9ecef;
                color: #444;
            }

            .chat-message.other.analyst .content {
                background-color: #d1ecf1;
                color: #0c5460;
            }

        .tab-nav {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .tab-link {
            padding: 0.75rem 1.25rem;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-size: 1rem;
            color: #495057;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

            .tab-link:hover {
                background-color: #f8f9fa;
                border-bottom-color: #e9ecef;
            }

            .tab-link.active {
                color: #007bff;
                font-weight: 600;
                border-bottom-color: #007bff;
            }

        #tab-link-admin {
            display: none;
            color: #dc3545;
            font-weight: 600;
        }

            #tab-link-admin.active {
                border-bottom-color: #dc3545;
            }

        #tab-link-perfil, #tab-link-client-perfil {
            color: #28a745;
            font-weight: 600;
        }

            #tab-link-perfil.active, #tab-link-client-perfil.active {
                border-bottom-color: #28a745;
            }


        .tab-content {
            display: none;
        }

            .tab-content.active {
                display: block;
            }

        #dashboard-stats-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            background-color: #fdfdfd;
        }

        .stats-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: center;
        }

        .stats-numeros {
            flex: 1 1 150px;
        }

            .stats-numeros ul {
                list-style: none;
                padding-left: 0;
                margin: 0;
            }

            .stats-numeros li {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem;
                border-bottom: 1px solid #eee;
            }

                .stats-numeros li .stat-label {
                    font-size: 0.9rem;
                    color: #333;
                }

                .stats-numeros li .stat-count {
                    font-size: 1.2rem;
                    font-weight: bold;
                    color: #0056b3;
                }

        .stats-grafico {
            flex: 1 1 200px;
            max-width: 300px;
            margin: 0 auto;
        }

        #stats-chart-canvas {
            max-width: 100%;
            height: auto;
        }

        /* --- Estilos dos Relatórios (sem alteração) --- */
        .db-loading {
            font-style: italic;
            color: #888;
        }

        .db-card-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 2.5rem;
        }

        .db-card {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            padding: 24px;
            border: 1px solid #eee;
            flex-basis: 250px;
            flex-grow: 1;
            min-height: 150px;
        }

            .db-card h4 {
                margin-top: 0;
                color: #555;
                border-bottom: 1px solid #eee;
                padding-bottom: 10px;
            }

        .db-stat-number {
            font-size: 3.5rem;
            font-weight: bold;
            color: #0056b3;
            text-align: center;
            margin: 20px 0;
        }

        .db-priority-list {
            list-style: none;
            padding: 0;
        }

            .db-priority-list li {
                font-size: 1.1rem;
                display: flex;
                justify-content: space-between;
                padding: 8px 0;
                border-bottom: 1px dashed #ddd;
            }

                .db-priority-list li strong {
                    color: #333;
                }

        .admin-checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

            .admin-checkbox-group input {
                width: auto;
                margin-right: 0.75rem;
                transform: scale(1.2);
            }

            .admin-checkbox-group label {
                margin-bottom: 0;
                font-weight: bold;
                color: #dc3545;
            }

        /* --- NOVO: Media Queries para Responsividade --- */
        @media (max-width: 768px) {
            body {
                padding: 0.5rem 0; /* Menos padding no body */
                -webkit-text-size-adjust: 100%; /* Previne zoom do iOS */
            }

            .container {
                padding: 1rem; /* Menos padding no container */
                width: 98%; /* Usar mais da tela */
                margin-top: 0.5rem;
                margin-bottom: 0.5rem;
            }

            h2, .header h2 {
                font-size: 1.25rem;
                margin-bottom: 1rem;
            }

            /* Ajusta cabeçalhos do Dashboard e Chat */
            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

                .header h2 {
                    text-align: center;
                }

                .header .btn-logout, .header .btn-action, .header .btn-back {
                    width: 100%;
                    margin: 0.2rem 0;
                    text-align: center;
                    padding: 0.75rem; /* Botões maiores para toque */
                }

            /* Abas de navegação */
            .tab-nav {
                flex-wrap: wrap; /* Quebra os botões da aba se não couberem */
            }

            .tab-link {
                font-size: 0.9rem;
                padding: 0.75rem 0.75rem; /* Facilita o toque */
                flex-grow: 1; /* Faz as abas ocuparem o espaço */
                text-align: center;
            }

            /* Layouts Flex (Stats, Cards de Relatório) */
            .stats-layout, .db-card-container {
                flex-direction: column; /* Empilha verticalmente */
            }

            .stats-grafico {
                max-width: 95%; /* Permitir o gráfico crescer */
                margin-top: 1rem;
            }

            /* Formulário de Chat */
            .chat-input-form {
                flex-direction: column; /* Empilha input e botão */
            }

                .chat-input-form input {
                    border-radius: 0;
                    font-size: 1rem; /* Garante que o zoom não seja aplicado */
                }

                .chat-input-form button {
                    width: 100%;
                    border-radius: 0 0 4px 4px;
                    padding: 0.85rem;
                }

            /* Controles do Analista */
            .analyst-controls-grid {
                flex-direction: column;
                gap: 0;
            }

                .analyst-controls-grid .form-group {
                    margin-bottom: 0.5rem; /* Reduz margem */
                }

            /* Mensagens de Chat */
            .chat-messages {
                height: 350px; /* Ajusta altura */
            }

            .chat-message {
                max-width: 95%; /* Mensagens podem ser mais largas */
            }
        }
        /* --- FIM DAS MEDIA QUERIES --- */

        /* --- FIM DO CSS --- */
    </style>
</head>
<body>

    <div class="container" id="main-container">
        <div id="message-area"></div>

        <div id="login-screen" class="screen active">
            <h2>NextLayer Login</h2>
            <form id="login-form">
                <div class="form-group"> <label for="login-email">E-mail</label> <input type="email" id="login-email" required autocomplete="email"> </div>
                <div class="form-group"> <label for="login-password">Senha</label> <input type="password" id="login-password" required autocomplete="current-password"> </div>
                <button type="submit" class="btn">Entrar</button>
            </form>
            <div class="nav-links">
                <span class="nav-link" id="nav-to-client-register">Cadastrar Cliente</span>
            </div>
        </div>

        <div id="client-register-screen" class="screen">
            <h2>Cadastro de Cliente</h2>
            <form id="client-register-form">
                <div class="form-group"> <label for="client-name">Nome Completo</label> <input type="text" id="client-name" required autocomplete="name"> </div>
                <div class="form-group"> <label for="client-email">E-mail</label> <input type="email" id="client-email" required autocomplete="email"> </div>
                <div class="form-group"> <label for="client-cpf">CPF</label> <input type="text" id="client-cpf" required> </div>
                <div class="form-group"> <label for="client-password">Senha (mín. 6)</label> <input type="password" id="client-password" minlength="6" required autocomplete="new-password"> </div>
                <div class="form-group"> <label for="client-confirm-password">Confirmar Senha</label> <input type="password" id="client-confirm-password" required autocomplete="new-password"> </div>
                <button type="submit" class="btn">Cadastrar</button>
            </form>
            <div class="nav-links">
                <span class="nav-link" id="nav-c-to-login">Voltar</span>
            </div>
        </div>

        <div id="client-dashboard-screen" class="screen">
            <div class="header"> <h2 id="client-dashboard-title">Portal do Cliente</h2> <button class="btn-logout" id="logout-client">Sair</button> </div>

            <div class="tab-nav">
                <button class="tab-link active" id="tab-link-client-novo">Abrir Chamado</button>
                <button class="tab-link" id="tab-link-client-lista">Meus Chamados</button>
                <button class="tab-link" id="tab-link-client-perfil">Meu Perfil</button>
            </div>

            <div id="tab-content-client-novo" class="tab-content active">
                <h3>Abrir Novo Chamado</h3>
                <form id="client-ticket-form">
                    <div class="form-group"> <label for="ticket-titulo">Título</label> <input type="text" id="ticket-titulo" required> </div>
                    <div class="form-group"> <label for="ticket-descricao">Descrição</label> <textarea id="ticket-descricao" rows="5" required></textarea> </div>
                    <div id="faq-sugestoes-container" style="display: none; margin-top: 1rem;"> <strong>Sugestões (FAQ):</strong> <ul id="faq-sugestoes-list" style="margin-top: 0.5rem; padding-left: 20px; list-style: disc;"></ul> </div>
                    <div class="form-group" style="margin-top: 1rem;"> <label for="ticket-imagens">Anexos (Opcional)</label> <input type="file" id="ticket-imagens" accept="image/*" multiple> </div>
                    <button type="submit" class="btn" id="btn-criar-chamado">Enviar e Abrir Chat</button>
                </form>
            </div>

            <div id="tab-content-client-lista" class="tab-content">
                <h3>Meus Chamados</h3>
                <div class="ticket-grid-container"> <table class="ticket-grid"> <thead> <tr> <th>Nº</th> <th>Título</th> <th>Abertura</th> <th>Status</th> </tr> </thead> <tbody id="client-ticket-grid-body"></tbody> </table> </div>
            </div>

            <div id="tab-content-client-perfil" class="tab-content">
                <h3>Alterar Minha Senha</h3>
                <form id="mudar-senha-form-client">
                    <div class="form-group"> <label for="client-senha-antiga">Senha Antiga</label> <input type="password" id="client-senha-antiga" required autocomplete="current-password"> </div>
                    <div class="form-group"> <label for="client-nova-senha">Nova Senha (mín. 6)</label> <input type="password" id="client-nova-senha" minlength="6" required autocomplete="new-password"> </div>
                    <div class="form-group"> <label for="client-confirmar-nova-senha">Confirmar Nova Senha</label> <input type="password" id="client-confirmar-nova-senha" required autocomplete="new-password"> </div>
                    <button type="submit" class="btn btn-success">Salvar Nova Senha</button>
                </form>
            </div>
        </div>

        <div id="employee-dashboard-screen" class="screen">
            <div class="header"> <h2 id="employee-dashboard-title">Painel do Analista</h2> <button class="btn-logout" id="logout-employee">Sair</button> </div>

            <div class="tab-nav">
                <button class="tab-link active" id="tab-link-reports">Relatórios</button>
                <button class="tab-link" id="tab-link-tickets">Chamados</button>
                <button class="tab-link" id="tab-link-admin">Gestão Admin</button>
                <button class="tab-link" id="tab-link-perfil">Meu Perfil</button>
            </div>

            <div id="tab-content-reports" class="tab-content active">
                <h3>Visão Geral</h3>
                <div class="db-card-container">
                    <div class="db-card"> <h4>Total de Chamados Abertos</h4> <div id="report-total-abertos" class="db-stat-number db-loading">...</div> </div>
                    <div class="db-card"> <h4>Abertos por Prioridade</h4> <ul id="report-por-prioridade" class="db-priority-list"> <li class="db-loading">Carregando...</li> </ul> </div>
                </div>
                <h3>Chamados Abertos Recentemente (Últimos 7 dias)</h3>
                <div class="ticket-grid-container" style="margin-top: 1rem; max-height: 250px;"> <table class="ticket-grid"> <thead> <tr> <th>Nº</th> <th>Título</th> <th>Abertura</th> <th>Status</th> </tr> </thead> <tbody id="report-recentes-body"> <tr><td colspan="4" class="db-loading" style="text-align: center;">Carregando...</td></tr> </tbody> </table> </div>
                <h3 style="margin-top: 2.5rem; border-top: 1px solid #eee; padding-top: 2rem;">Relatório de Status</h3>
                <div id="dashboard-stats-container"> <p id="stats-loading-message" style="color: #666;">Carregando estatísticas...</p> </div>
            </div>

            <div id="tab-content-tickets" class="tab-content">
                <h3>Meus Chamados Atribuídos (Não Concluídos)</h3>
                <div class="ticket-grid-container"> <table class="ticket-grid"> <thead> <tr> <th>Nº</th> <th>Título</th> <th>Cliente</th> <th>Abertura</th> <th>Status</th> </tr> </thead> <tbody id="my-assigned-grid-body"></tbody> </table> </div>
                <h3 style="margin-top: 2.5rem; border-top: 1px solid #eee; padding-top: 2rem;">Todos Chamados (Abertos/Em Andamento)</h3>
                <div class="ticket-grid-container"> <table class="ticket-grid"> <thead> <tr> <th>Nº</th> <th>Título</th> <th>Cliente</th> <th>Abertura</th> <th>Status</th> <th>Analista</th> </tr> </thead> <tbody id="analyst-ticket-grid-body"></tbody> </table> </div>
            </div>

            <div id="tab-content-admin" class="tab-content">

                <h3>Funcionários Cadastrados</h3>
                <div class="ticket-grid-container" style="margin-top: 1rem; max-height: 250px;">
                    <table class="ticket-grid">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>E-mail</th>
                                <th>Cargo</th>
                                <th>Admin?</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="employee-list-body">
                            <tr><td colspan="5" class="db-loading" style="text-align: center;">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
                <h3 style="margin-top: 2.5rem; border-top: 1px solid #eee; padding-top: 2rem;" id="admin-form-title">Cadastrar Novo Funcionário</h3>
                <p id="admin-form-desc">Use este formulário para criar novas contas de Analista ou Administrador.</p>

                <form id="admin-register-form">
                    <input type="hidden" id="admin-editing-user-id" value="">

                    <div class="form-group"> <label for="admin-name">Nome Completo</label> <input type="text" id="admin-name" required autocomplete="name"> </div>

                    <div class="form-group"> <label for="admin-email">E-mail Institucional</label> <input type="email" id="admin-email" required autocomplete="email"> </div>

                    <div class="form-group"> <label for="admin-role">Cargo (Ex: Analista N1, Admin)</label> <input type="text" id="admin-role" required> </div>

                    <div id="admin-password-group">
                        <div class="form-group"> <label for="admin-password">Senha (mín. 6)</label> <input type="password" id="admin-password" minlength="6" required autocomplete="new-password"> </div>
                        <div class="form-group"> <label for="admin-confirm-password">Confirmar Senha</label> <input type="password" id="admin-confirm-password" required autocomplete="new-password"> </div>
                    </div>
                    <div class="admin-checkbox-group"> <input type="checkbox" id="admin-is-admin"> <label for="admin-is-admin">Tornar este usuário um Administrador</label> </div>

                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn" id="admin-submit-button">Cadastrar Novo Funcionário</button>
                        <button type="button" class="btn btn-grid-cancel hidden" id="btn-cancel-edit">Cancelar Edição</button>
                    </div>
                </form>


                <h3 style="margin-top: 2.5rem; border-top: 1px solid #eee; padding-top: 2rem;">Redefinir Senha de Usuário</h3>
                <p>Use este formulário para forçar uma nova senha para qualquer usuário (Cliente ou Funcionário) que a esqueceu.</p>
                <form id="admin-reset-password-form">
                    <div class="form-group"> <label for="admin-reset-email">E-mail do Usuário (Cliente ou Funcionário)</label> <input type="email" id="admin-reset-email" required autocomplete="email"> </div>
                    <div class="form-group"> <label for="admin-reset-nova-senha">Nova Senha (mín. 6)</label> <input type="password" id="admin-reset-nova-senha" minlength="6" required autocomplete="new-password"> </div>
                    <div class="form-group"> <label for="admin-reset-confirmar-nova-senha">Confirmar Nova Senha</label> <input type="password" id="admin-reset-confirmar-nova-senha" required autocomplete="new-password"> </div>
                    <button type="submit" class="btn btn-warning">Redefinir Senha do Usuário</button>
                </form>
            </div>

            <div id="tab-content-perfil" class="tab-content">
                <h3>Alterar Minha Senha</h3>
                <form id="mudar-senha-form-employee">
                    <div class="form-group"> <label for="employee-senha-antiga">Senha Antiga</label> <input type="password" id="employee-senha-antiga" required autocomplete="current-password"> </div>
                    <div class="form-group"> <label for="employee-nova-senha">Nova Senha (mín. 6)</label> <input type="password" id="employee-nova-senha" minlength="6" required autocomplete="new-password"> </div>
                    <div class="form-group"> <label for="employee-confirmar-nova-senha">Confirmar Nova Senha</label> <input type="password" id="employee-confirmar-nova-senha" required autocomplete="new-password"> </div>
                    <button type="submit" class="btn btn-success">Salvar Nova Senha</button>
                </form>
            </div>
        </div>

        <div id="chat-screen" class="screen">
            <div class="header"> <button class="btn-back" id="chat-btn-back">← Voltar</button> <h2 id="chat-header-title">Chat</h2> <button class="btn-action" id="chat-btn-refresh">↻</button> <button class="btn-logout" id="logout-chat">Sair</button> </div>
            <div id="analyst-controls">
                <h4>Controles</h4>
                <div class="analyst-controls-grid">
                    <div class="form-group"> <label for="analyst-select-status">Status</label> <select id="analyst-select-status"> <option value="Aberto (IA)">Aberto (IA)</option> <option value="Aguardando Analista">Aguardando Analista</option> <option value="Em Andamento (Analista)">Em Andamento (Analista)</option> <option value="Aguardando Cliente">Aguardando Cliente</option> <option value="Concluído">Concluído</option> <option value="Encerrado">Encerrado</option> <option value="Cancelado">Cancelado</option> </select> </div>
                    <div class="form-group"> <label for="analyst-select-priority">Prioridade</label> <select id="analyst-select-priority"> <option value="Baixa">Baixa</option> <option value="Média">Média</option> <option value="Alta">Alta</option> </select> </div>
                    <div class="form-group"> <label for="analyst-select-assignee">Analista</label> <select id="analyst-select-assignee"> <option value="">-- Nenhum --</option> </select> </div>
                </div>
                <button class="btn" id="btn-save-analyst-changes">Salvar</button>
            </div>
            <div class="chat-container">
                <div class="chat-header"> <h4 id="chat-titulo">...</h4> <span id="chat-numero">...</span> </div>
                <div class="anexos-list" id="chat-anexos-container" style="display: none;"> <strong>Anexos:</strong> <ul id="chat-anexos-list"></ul> </div>
                <div class="chat-messages" id="chat-messages-area"></div>
                <form class="chat-input-form" id="chat-message-form"> <input type="text" id="chat-message-input" placeholder="..." required autocomplete="off"> <button type="submit" id="btn-enviar-msg">Enviar</button> </form>
            </div>
        </div>
    </div>

    <script>
        /* --- INÍCIO DO JAVASCRIPT --- */

        document.addEventListener("DOMContentLoaded", function () {

            // --- CONFIGURAÇÃO E VARIÁVEIS GLOBAIS ---
            const API_URL = "https://localhost:7121";
            const DASHBOARD_API_URL = `${API_URL}/api/dashboard`;
            // --- NOVO: API de Funcionários ---
            const EMPLOYEE_API_URL = `${API_URL}/api/employee`;

            const MAX_FILE_SIZE_MB = 5;
            const MAX_TOTAL_FILES = 5;
            const messageArea = document.getElementById('message-area');
            const mainContainer = document.getElementById('main-container');

            let currentUserType = null;
            let currentUserIsAdmin = false;
            let currentChamadoId = null;
            let faqSuggestionTimeoutId = null;
            let currentChamadoDetails = null;
            let listaAnalistasCache = null;
            let statsChartInstance = null;

            // --- NOVO: Cache para a lista de funcionários (para edição) ---
            let employeeListCache = [];

            // --- NOVO: Variável para o Polling ---
            let chatPollingInterval = null;

            // --- FUNÇÕES AUXILIARES (Sem alterações) ---
            function showScreen(screenId) { try { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); const sS = document.getElementById(screenId); if (sS) { sS.classList.add('active'); if (screenId.includes('dashboard-screen')) { mainContainer.classList.add('dashboard-active'); } else { mainContainer.classList.remove('dashboard-active'); } } else { console.error("Tela Inválida:", screenId); document.getElementById('login-screen').classList.add('active'); mainContainer.classList.remove('dashboard-active'); } showMessage('', false); window.scrollTo(0, 0); } catch (e) { console.error("Erro em showScreen:", e); } }
            function showMessage(message, isError = false) { if (!messageArea) return; try { if (messageArea.timerId) clearTimeout(messageArea.timerId); messageArea.textContent = message; messageArea.className = message ? (isError ? 'error' : 'success') : ''; const t = isError ? 8000 : 5000; if (message) { messageArea.timerId = setTimeout(() => { showMessage(''); }, t); } } catch (e) { console.error("Erro em showMessage:", e); } }
            function formatISODate(iso) { if (!iso) return '-'; try { return new Date(iso).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); } catch (e) { console.error("Erro formatar data:", iso, e); return iso; } }
            function formatISODateRecente(iso) { if (!iso) return '-'; try { return new Date(iso).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }); } catch (e) { return iso; } }
            function disableForm(formId, disable = true) { try { const f = document.getElementById(formId); if (!f) { console.warn("Elemento não encontrado:", formId); return; } const els = f.querySelectorAll('input, select, textarea, button'); els.forEach(el => { if (el) el.disabled = disable; }); let btn; if (formId === 'analyst-controls') { btn = document.getElementById('btn-save-analyst-changes'); } else if (f.tagName === 'FORM') { btn = f.querySelector('button[type="submit"]'); } else { return; } if (btn) { const oTxt = btn.dataset.originalText || btn.textContent; if (disable && !btn.dataset.originalText) { btn.dataset.originalText = oTxt; } let wTxt = 'Aguarde...'; if (formId === 'analyst-controls' || formId.startsWith('mudar-senha-form') || formId === 'admin-reset-password-form') { wTxt = 'Salvando...'; } if (formId === 'admin-register-form') { wTxt = 'Cadastrando...'; } if (formId === 'client-ticket-form') { wTxt = 'Enviando...'; } btn.textContent = disable ? wTxt : oTxt; if (!disable) delete btn.dataset.originalText; } } catch (e) { console.error("Erro em disableForm:", e, formId); } }

            function logout() {
                // --- NOVO: Para polling ---
                stopChatPolling();
                // --- FIM NOVO ---
                currentUserType = null; currentChamadoId = null; listaAnalistasCache = null; currentUserIsAdmin = false;
                localStorage.removeItem('jwtToken');
                localStorage.removeItem('userName');
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('userType'); // <-- ALTERAÇÃO: Limpa o tipo de usuário
                try { document.getElementById('analyst-ticket-grid-body').innerHTML = ''; } catch (e) { }
                try { document.getElementById('my-assigned-grid-body').innerHTML = ''; } catch (e) { }
                try { document.getElementById('client-ticket-grid-body').innerHTML = ''; } catch (e) { }
                try { if (statsChartInstance) { statsChartInstance.destroy(); statsChartInstance = null; } const sC = document.getElementById('dashboard-stats-container'); if (sC) { sC.innerHTML = '<p id="stats-loading-message" style="color: #666;">Carregando...</p>'; } } catch (e) { }
                try { document.getElementById('report-total-abertos').innerHTML = '<div class="db-stat-number db-loading">...</div>'; } catch (e) { }
                try { document.getElementById('report-por-prioridade').innerHTML = '<li class="db-loading">Carregando...</li>'; } catch (e) { }
                try { document.getElementById('report-recentes-body').innerHTML = '<tr><td colspan="4" class="db-loading" style="text-align: center;">Carregando...</td></tr>'; } catch (e) { }
                try { document.getElementById('employee-list-body').innerHTML = ''; } catch (e) { }
                ['login-form', 'client-register-form', 'client-ticket-form', 'chat-message-form', 'analyst-controls', 'admin-register-form', 'mudar-senha-form-client', 'mudar-senha-form-employee', 'admin-reset-password-form'].forEach(id => { const el = document.getElementById(id); if (el) { if (el.tagName === 'FORM') el.reset(); else { try { el.querySelectorAll('select').forEach(s => s.selectedIndex = 0); el.querySelectorAll('input:not([type=hidden])').forEach(i => i.value = ''); } catch (e) { } } } });
                try { document.getElementById('client-dashboard-title').textContent = "Portal do Cliente"; } catch (e) { }
                try { document.getElementById('employee-dashboard-title').textContent = "Painel do Analista"; } catch (e) { }
                try { document.getElementById('tab-link-admin').style.display = 'none'; } catch (e) { }
                showScreen('login-screen');
            }

            // --- NOVO: Função para verificar sessão existente ---
            function checkExistingSession() {
                const token = localStorage.getItem('jwtToken');
                const userName = localStorage.getItem('userName');
                const userType = localStorage.getItem('userType'); // <-- O novo item
                const isAdmin = localStorage.getItem('isAdmin') === 'true'; // Converte string para booleano

                if (token && userName && userType) {
                    console.log("Sessão existente encontrada:", userType);

                    // 1. Popula as variáveis globais (igual no login)
                    currentUserType = userType;
                    currentUserIsAdmin = isAdmin;

                    // 2. Mostra o dashboard correto, pulando o login
                    if (userType === "Client") {
                        showScreen('client-dashboard-screen');
                        loadClientDashboard();
                    } else if (userType === "Employee") {
                        showScreen('employee-dashboard-screen');
                        loadEmployeeDashboard();
                    }
                } else {
                    console.log("Nenhuma sessão ativa. Exibindo login.");
                    // Não faz nada, pois o HTML padrão (screen active) já mostra a tela de login.
                }
            }

            // --- NOVO: Funções de Polling do Chat ---

            // Para o polling quando saímos do chat
            function stopChatPolling() {
                if (chatPollingInterval) {
                    clearInterval(chatPollingInterval);
                    chatPollingInterval = null;
                    console.log("Polling do chat interrompido.");
                }
            }

            // Função que será chamada a cada 5 segundos
            async function pollChatMessages() {
                // Para se o ID mudou ou se a tela do chat não está ativa
                if (!currentChamadoId || document.getElementById('chat-screen').classList.contains('active') === false) {
                    stopChatPolling();
                    return;
                }

                console.log("Polling: Verificando novas mensagens...");
                try {
                    // Re-buscamos os detalhes completos.
                    // A API GET /api/Chamado/{id} já retorna as mensagens.
                    const r = await fetchAutenticado(`${API_URL}/api/Chamado/${currentChamadoId}`);
                    if (!r.ok) {
                        console.warn("Erro no polling, pulando ciclo.");
                        return; // Não para o polling, só pula este ciclo.
                    }

                    const data = await r.json();
                    currentChamadoDetails = data; // Atualiza os detalhes (status, etc.)

                    // --- Otimização ---
                    // Conta as mensagens atuais na tela e as que vieram da API
                    const novasMensagens = data.mensagens || [];
                    const msgCountApi = novasMensagens.length;
                    const msgCountTela = document.getElementById('chat-messages-area').querySelectorAll('.chat-message').length;

                    // Só renderiza de novo se a contagem de mensagens for diferente
                    if (msgCountApi !== msgCountTela) {
                        console.log("Novas mensagens detectadas, renderizando!");

                        const chatArea = document.getElementById('chat-messages-area');
                        // Verifica se o usuário estava no final do chat antes de renderizar
                        const isScrolledToBottom = chatArea.scrollHeight - chatArea.clientHeight <= chatArea.scrollTop + 15; // 15px de margem

                        renderizarMensagens(novasMensagens); // Re-renderiza

                        // Se estava no final, força o scroll para o final de novo
                        if (isScrolledToBottom) {
                            chatArea.scrollTop = chatArea.scrollHeight;
                        }
                    }

                    // Atualiza o status no header do chat (pode ter mudado)
                    document.getElementById('chat-numero').textContent = `${data.numeroChamado || 'N/A'} (${data.status || 'N/A'})`;

                } catch (e) {
                    console.error("Erro durante o polling do chat:", e);
                    // Não paramos o polling por erro de rede, ele tentará novamente.
                }
            }
            // --- FIM NOVAS FUNÇÕES ---

            async function fetchAutenticado(url, options = {}) { const t = localStorage.getItem('jwtToken'); const h = new Headers(options.headers || {}); if (t) { h.append('Authorization', `Bearer ${t}`); } if (options.body && !(options.body instanceof FormData) && !h.has('Content-Type')) { h.append('Content-Type', 'application/json'); } options.headers = h; const r = await fetch(url, options); if (r.status === 401) { console.warn("401. Forçando logout."); showMessage("Sessão expirada. Faça login.", true); logout(); throw new Error("Sessão expirada."); } if (r.status === 403) { console.warn("403. Proibido."); try { const e = await r.json(); throw new Error(e.message || "Acesso negado."); } catch (e) { throw new Error("Acesso negado."); } } return r; }

            // --- LÓGICA DE CARREGAMENTO DOS PAINÉIS (Sem alterações) ---
            async function loadNewDashboardReports() { const t = document.getElementById('report-total-abertos'); const p = document.getElementById('report-por-prioridade'); const r = document.getElementById('report-recentes-body'); if (t) t.innerHTML = '<div class="db-stat-number db-loading">...</div>'; if (p) p.innerHTML = '<li class="db-loading">Carregando...</li>'; if (r) r.innerHTML = '<tr><td colspan="4" class="db-loading" style="text-align: center;">Carregando...</td></tr>'; try { const [tR, pR, rR] = await Promise.all([fetchAutenticado(`${DASHBOARD_API_URL}/total-abertos`), fetchAutenticado(`${DASHBOARD_API_URL}/por-prioridade`), fetchAutenticado(`${DASHBOARD_API_URL}/recentes?dias=7`)]); if (tR.ok) { renderNewTotal(t, await tR.json()); } else { renderNewTotal(t, 'Erro'); } if (pR.ok) { renderNewPrioridade(p, await pR.json()); } else { renderNewPrioridade(p, null, true); } if (rR.ok) { renderNewRecentes(r, await rR.json()); } else { renderNewRecentes(r, null, true); } } catch (e) { console.error('Erro ao carregar novos relatórios:', e); if (e.message !== "Sessão expirada.") { renderNewTotal(t, 'X'); renderNewPrioridade(p, null, true); renderNewRecentes(r, null, true); } } }
            function renderNewTotal(el, tot) { if (!el) return; el.textContent = tot; el.classList.remove('db-loading'); if (isNaN(tot)) el.style.fontSize = "2rem"; else el.style.fontSize = "3.5rem"; }
            function renderNewPrioridade(listEl, data, isErr = false) { if (!listEl) return; listEl.innerHTML = ''; if (isErr) { listEl.innerHTML = '<li style="color: red;">Erro.</li>'; return; } if (!data || Object.keys(data).length === 0) { listEl.innerHTML = '<li>Nenhum chamado.</li>'; return; } Object.entries(data).forEach(([p, t]) => { const li = document.createElement('li'); li.innerHTML = `<strong>${p}</strong> <span>${t}</span>`; listEl.appendChild(li); }); }
            function renderNewRecentes(tbl, data, isErr = false) { if (!tbl) return; tbl.innerHTML = ''; if (isErr) { tbl.innerHTML = '<tr><td colspan="4" style="text-align: center; color: red;">Erro.</td></tr>'; return; } if (!data || data.length === 0) { tbl.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum chamado.</td></tr>'; return; } data.forEach(c => { const tr = document.createElement('tr'); tr.innerHTML = ` <td data-action="abrirChat" class="grid-clickable-cell">${c.numeroChamado || c.id}</td> <td>${c.titulo || '-'}</td> <td>${formatISODateRecente(c.dataAbertura)}</td> <td>${c.status || '-'}</td> `; tr.dataset.id = c.id; tbl.appendChild(tr); }); }
            async function loadDashboardStats() { const sC = document.getElementById('dashboard-stats-container'); const lM = document.getElementById('stats-loading-message'); if (!sC) return; if (sC.querySelector('.stats-layout')) sC.querySelector('.stats-layout').remove(); if (statsChartInstance) { statsChartInstance.destroy(); statsChartInstance = null; } if (lM) { lM.textContent = "Carregando..."; lM.style.display = 'block'; } else { sC.innerHTML = '<p id="stats-loading-message" style="color: #666;">Carregando...</p>'; } try { const r = await fetchAutenticado(`${API_URL}/api/Dashboard/stats/por-status`); if (!r.ok) { const e = await r.json(); throw new Error(e.message || `Erro ${r.status}`); } const s = await r.json(); const lM2 = document.getElementById('stats-loading-message'); if (lM2) lM2.style.display = 'none'; if (!s || s.length === 0) { sC.innerHTML = '<p id="stats-loading-message">Nenhum dado.</p>'; return; } sC.innerHTML = ` <div class="stats-layout"> <div class="stats-numeros"><ul id="stats-list"></ul></div> <div class="stats-grafico"><canvas id="stats-chart-canvas"></canvas></div> </div> `; const sL = document.getElementById('stats-list'); let t = 0; s.forEach(i => { t += i.contagem; sL.innerHTML += `<li><span class="stat-label">${i.status}</span><span class="stat-count">${i.contagem}</span></li>`; }); sL.innerHTML += `<li style="border-top:2px solid #007bff; margin-top:0.5rem; padding-top:0.5rem;"><span class="stat-label"><strong>Total</strong></span><span class="stat-count"><strong>${t}</strong></span></li>`; if (typeof Chart !== 'undefined') { const ctx = document.getElementById('stats-chart-canvas').getContext('2d'); statsChartInstance = new Chart(ctx, { type: 'pie', data: { labels: s.map(i => i.status), datasets: [{ data: s.map(i => i.contagem), backgroundColor: ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)', 'rgba(100, 100, 100, 0.7)'], borderColor: '#fff', borderWidth: 1 }] }, options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Distribuição de Status' } } } }); } else { console.error("Chart.js não foi carregado."); const g = document.querySelector('.stats-grafico'); if (g) g.innerHTML = `<p style="color:red;">Erro: Gráfico não carregou.</p>`; } } catch (e) { console.error("Erro stats:", e); if (e.message !== "Sessão expirada.") { const m = document.getElementById('stats-loading-message'); if (m) m.style.display = 'none'; else sC.innerHTML = ''; sC.innerHTML += `<p style="color:red;">Erro: ${e.message}</p>`; } } }
            async function loadEmployeeDashboard() { try { const u = localStorage.getItem('userName') || 'Analista'; document.getElementById('employee-dashboard-title').innerHTML = `Painel <span class="user-name">(${u})</span>`; } catch (e) { console.error("Erro nome analista:", e); } try { const aT = document.getElementById('tab-link-admin'); if (currentUserIsAdmin) { aT.style.display = 'block'; } else { aT.style.display = 'none'; } } catch (e) { console.error("Erro aba admin:", e); } showAnalystTab('reports'); loadNewDashboardReports(); loadDashboardStats(); loadEmployeeGrids(); loadEmployeeList(); /* <-- NOVO: Carrega a lista de funcionários */ }
            async function loadEmployeeGrids() { const myGb = document.getElementById('my-assigned-grid-body'); if (myGb) { myGb.innerHTML = `<tr><td colspan="5">Carregando...</td></tr>`; try { const r = await fetchAutenticado(`${API_URL}/api/Chamado/meus-chamados-analista`); if (!r.ok) throw new Error(`Erro ${r.status}.`); const c = await r.json(); myGb.innerHTML = ''; if (!c || c.length === 0) { myGb.innerHTML = `<tr><td colspan="5">Nenhum chamado.</td></tr>`; } else { c.forEach(ch => { const o = ["Aberto (IA)", "Aguardando Analista", "Em Andamento (Analista)", "Aguardando Cliente", "Concluído", "Encerrado", "Cancelado"]; let sH = `<select class="status-select" data-id="${ch.id}" data-grid-type="my-grid">`; o.forEach(opt => { sH += `<option value="${opt}" ${opt === (ch.status || '') ? 'selected' : ''}>${opt}</option>`; }); sH += `</select>`; myGb.innerHTML += `<tr data-id="${ch.id}"><td data-action="abrirChat" class="grid-clickable-cell">${ch.numeroChamado || '-'}</td><td>${ch.titulo || '-'}</td><td>${ch.nomeCliente || '-'}</td><td>${formatISODate(ch.dataAbertura)}</td> <td>${sH}</td></tr>`; }); } } catch (e) { console.error('Erro meus chamados:', e); if (e.message !== "Sessão expirada.") myGb.innerHTML = `<tr><td colspan="5" style="color:red;">${e.message || 'Erro.'}</td></tr>`; } } const gB = document.getElementById('analyst-ticket-grid-body'); if (!gB) return; gB.innerHTML = `<tr><td colspan="6">Carregando...</td></tr>`; try { const r = await fetchAutenticado(`${API_URL}/api/Chamado/abertos`); if (!r.ok) throw new Error(`Erro ${r.status}.`); const c = await r.json(); gB.innerHTML = ''; if (!c || c.length === 0) { gB.innerHTML = `<tr><td colspan="6">Nenhum chamado.</td></tr>`; return; } c.forEach(ch => { const o = ["Aberto (IA)", "Aguardando Analista", "Em Andamento (Analista)", "Aguardando Cliente", "Concluído", "Encerrado", "Cancelado"]; let sH = `<select class="status-select" data-id="${ch.id}" data-grid-type="all-grid">`; o.forEach(opt => { sH += `<option value="${opt}" ${opt === (ch.status || '') ? 'selected' : ''}>${opt}</option>`; }); sH += `</select>`; gB.innerHTML += `<tr data-id="${ch.id}"><td data-action="abrirChat" class="grid-clickable-cell">${ch.numeroChamado || '-'}</td><td>${ch.titulo || '-'}</td><td>${ch.nomeCliente || '-'}</td><td>${formatISODate(ch.dataAbertura)}</td><td>${sH}</td><td>${ch.nomeAnalista || '--'}</td></tr>`; }); } catch (e) { console.error('Erro todos chamados:', e); if (e.message !== "Sessão expirada.") gB.innerHTML = `<tr><td colspan="6" style="color:red;">${e.message || 'Erro.'}</td></tr>`; } }
            async function loadClientDashboard() { try { const u = localStorage.getItem('userName') || 'Cliente'; document.getElementById('client-dashboard-title').innerHTML = `Portal <span class="user-name">(${u})</span>`; } catch (e) { console.error("Erro nome cliente:", e); } showClientTab('client-novo'); const gB = document.getElementById('client-ticket-grid-body'); if (!gB) return; gB.innerHTML = `<tr><td colspan="4">Carregando...</td></tr>`; try { const r = await fetchAutenticado(`${API_URL}/api/Chamado/meuschamados`); if (!r.ok) throw new Error(`Erro ${r.status}.`); const c = await r.json(); gB.innerHTML = ''; if (!c || c.length === 0) { gB.innerHTML = `<tr><td colspan="4">Nenhum chamado.</td></tr>`; return; } c.forEach(ch => { gB.innerHTML += `<tr data-id="${ch.id}"><td data-action="abrirChat" class="grid-clickable-cell">${ch.numeroChamado || '-'}</td><td data-action="abrirChat" class="grid-clickable-cell">${ch.titulo || '-'}</td><td>${formatISODate(ch.dataAbertura)}</td><td>${ch.status || '-'}</td></tr>`; }); } catch (e) { console.error('Erro load cliente:', e); if (e.message !== "Sessão expirada.") gB.innerHTML = `<tr><td colspan="4" style="color:red;">${e.message || 'Erro.'}</td></tr>`; } }
            async function carregarAnalistasDropdown(selId, selAId = null) { const s = document.getElementById(selId); if (!s) { console.error("Dropdown não encontrado:", selId); return; } s.options.length = 1; try { if (!listaAnalistasCache) { console.log("Buscando analistas..."); const r = await fetchAutenticado(`${API_URL}/api/Employee/analistas`); if (!r.ok) throw new Error(`Erro ${r.status}`); listaAnalistasCache = await r.json(); } if (listaAnalistasCache && listaAnalistasCache.length > 0) { listaAnalistasCache.forEach(a => { const o = document.createElement('option'); o.value = a.id; o.textContent = `${a.nome} (${a.funcao || 'N/A'})`; if (selAId && a.id === selAId) { o.selected = true; } s.appendChild(o); }); } } catch (e) { console.error("Erro carregar analistas:", e); const o = document.createElement('option'); o.value = ""; o.textContent = "Erro"; o.disabled = true; s.appendChild(o); } }
            async function handleStatusChange(sel) { const id = sel.dataset.id; const s = sel.value; if (!id || !s) return; sel.disabled = true; showMessage(`Salvando...`, false); let oS = ''; try { const rG = await fetchAutenticado(`${API_URL}/api/Chamado/${id}`); if (!rG.ok) throw new Error(`Erro ${rG.status}.`); const cA = await rG.json(); oS = cA.status || ''; if (!cA) throw new Error("Dados atuais não carregados."); const d = { Status: s, Prioridade: cA.prioridade || 'Média', AnalistaId: cA.analistaId || null }; const rP = await fetchAutenticado(`${API_URL}/api/Chamado/${id}/atualizar`, { method: 'PUT', body: JSON.stringify(d) }); if (!rP.ok) { const ed = await rP.json(); throw new Error(ed.message || `Erro ${rP.status}.`); } showMessage('Status atualizado!', false); loadEmployeeGrids(); } catch (e) { console.error('Erro status grid:', e); if (e.message !== "Sessão expirada.") showMessage(`Erro: ${e.message}`, true); try { sel.value = oS; } catch (rE) { } } finally { sel.disabled = false; } }

            async function abrirChat(chamadoId) {
                if (!chamadoId) return;

                // --- NOVO: Para qualquer polling antigo ---
                stopChatPolling();
                // --- FIM NOVO ---

                currentChamadoId = chamadoId;
                showScreen('chat-screen');
                const ctl = document.getElementById('analyst-controls');
                const cI = document.getElementById('chat-message-input');
                const tit = document.getElementById('chat-titulo');
                const num = document.getElementById('chat-numero');
                const aC = document.getElementById('chat-anexos-container');
                const aL = document.getElementById('chat-anexos-list');
                const mA = document.getElementById('chat-messages-area');
                tit.textContent = 'Carregando...'; num.textContent = '...'; if (aL) aL.innerHTML = ''; if (aC) aC.style.display = 'none'; if (mA) mA.innerHTML = '<p style="text-align:center; color:#999;">Carregando...</p>'; disableForm('chat-message-form', true); disableForm('analyst-controls', true); if (ctl) ctl.style.display = 'none'; currentChamadoDetails = null;
                try {
                    const r = await fetchAutenticado(`${API_URL}/api/Chamado/${chamadoId}`); if (!r.ok) throw new Error(`Erro ${r.status}.`); currentChamadoDetails = await r.json(); const c = currentChamadoDetails; console.log("Dados chat:", c); if (!c) throw new Error("Resposta inválida (null)."); tit.textContent = c.titulo || 'S/ Título'; num.textContent = `${c.numeroChamado || 'N/A'} (${c.status || 'N/A'})`; if (c.anexos && c.anexos.length > 0) { let h = ''; c.anexos.forEach(a => { if (a.urlArquivo && a.nomeArquivo) { const s = a.nomeArquivo.replace(/</g, "&lt;").replace(/>/g, "&gt;"); h += `<li><a href="${a.urlArquivo}" target="_blank">${s}</a></li>`; } }); if (h) { aL.innerHTML = h; aC.style.display = 'block'; } } renderizarMensagens(c.mensagens || []); if (currentUserType === 'Employee') { ctl.style.display = 'block'; try { document.getElementById('analyst-select-status').value = c.status || ''; } catch (e) { console.warn(e); } try { document.getElementById('analyst-select-priority').value = c.prioridade || 'Média'; } catch (e) { console.warn(e); } await carregarAnalistasDropdown('analyst-select-assignee', c.analistaId); disableForm('analyst-controls', false); } let iB = false; if (c.status === 'Encerrado' || c.status === 'Cancelado') { iB = true; } else if (c.status === 'Concluído' && c.dataConclusao) { try { const dC = new Date(c.dataConclusao); const ag = new Date(); const dH = (ag - dC) / 36e5; if (dH > 72) iB = true; } catch (e) { console.error(e); } } if (iB && currentUserType === 'Client') { cI.placeholder = "Este chamado está encerrado."; showMessage("Este chamado está encerrado.", true); disableForm('chat-message-form', true); } else { cI.placeholder = "Digite sua mensagem..."; disableForm('chat-message-form', false); }

                    // --- NOVO: Inicia o polling após carregar o chat ---
                    stopChatPolling(); // Garante que parou (de novo)
                    chatPollingInterval = setInterval(pollChatMessages, 5000); // Verifica a cada 5 segundos
                    // --- FIM NOVO ---

                } catch (e) { console.error('Erro abrir chat:', e); if (e.message !== "Sessão expirada.") showMessage(`Erro chat: ${e.message}`, true); mA.innerHTML = `<p style="color:red;">Falha ao carregar dados.</p>`; }
            }

            function renderizarMensagens(msgs) { const a = document.getElementById('chat-messages-area'); if (!a) return; a.innerHTML = ''; if (!msgs || msgs.length === 0) { a.innerHTML = `<p style="text-align:center; color:#999;">Sem mensagens.</p>`; return; } try { msgs.forEach(m => { if (!m) { console.warn("Msg inválida:", m); return; } const d = formatISODate(m.dataEnvio); let rc = '', ac = ''; const t = m.tipoRemetente || 'IA'; const u = currentUserType || 'Client'; if (t === 'Client') rc = 'client'; else if (t === 'Employee') rc = 'analyst'; else rc = 'ia'; if ((t === 'Client' && u === 'Client') || (t === 'Employee' && u === 'Employee')) { ac = 'viewer'; } else { ac = 'other'; } const sC = (m.conteudo || '').replace(/</g, "&lt;").replace(/>/g, "&gt;"); const sS = (m.remetenteNome || 'Desc.').replace(/</g, "&lt;").replace(/>/g, "&gt;"); a.innerHTML += `<div class="chat-message ${ac} ${rc}"><span class="sender">${sS}<span class="timestamp">${d}</span></span><div class="content">${sC}</div></div>`; }); setTimeout(() => { a.scrollTop = a.scrollHeight; }, 50); } catch (err) { console.error("Erro renderizar:", err, msgs); a.innerHTML = `<p style="color:red;">Erro exibir msgs.</p>`; } }
            function showAnalystTab(tabName) { try { document.querySelectorAll('#employee-dashboard-screen .tab-content').forEach(c => c.classList.remove('active')); document.querySelectorAll('#employee-dashboard-screen .tab-link').forEach(l => l.classList.remove('active')); document.getElementById(`tab-content-${tabName}`).classList.add('active'); document.getElementById(`tab-link-${tabName}`).classList.add('active'); } catch (e) { console.error("Erro aba Analista:", e, tabName); } }
            function showClientTab(tabName) { try { document.querySelectorAll('#client-dashboard-screen .tab-content').forEach(c => c.classList.remove('active')); document.querySelectorAll('#client-dashboard-screen .tab-link').forEach(l => l.classList.remove('active')); document.getElementById(`tab-content-${tabName}`).classList.add('active'); document.getElementById(`tab-link-${tabName}`).classList.add('active'); } catch (e) { console.error("Erro aba Cliente:", e, tabName); } }

            // --- EVENT LISTENERS ---
            document.getElementById('tab-link-reports').addEventListener('click', () => showAnalystTab('reports'));
            document.getElementById('tab-link-tickets').addEventListener('click', () => showAnalystTab('tickets'));
            document.getElementById('tab-link-admin').addEventListener('click', () => { showAnalystTab('admin'); loadEmployeeList(); /* <-- NOVO: Carrega a lista ao clicar na aba */ });
            document.getElementById('tab-link-perfil').addEventListener('click', () => showAnalystTab('perfil'));
            document.getElementById('tab-link-client-novo').addEventListener('click', () => showClientTab('client-novo'));
            document.getElementById('tab-link-client-lista').addEventListener('click', () => showClientTab('client-lista'));
            document.getElementById('tab-link-client-perfil').addEventListener('click', () => showClientTab('client-perfil'));
            document.getElementById('nav-to-client-register').addEventListener('click', () => showScreen('client-register-screen'));
            document.getElementById('nav-c-to-login').addEventListener('click', () => showScreen('login-screen'));
            document.getElementById('logout-client').addEventListener('click', logout);
            document.getElementById('logout-employee').addEventListener('click', logout);
            document.getElementById('logout-chat').addEventListener('click', logout);

            document.getElementById('chat-btn-back').addEventListener('click', () => {
                // --- NOVO ---
                stopChatPolling();
                // --- FIM NOVO ---
                currentChamadoId = null; const s = currentUserType === "Client" ? 'client-dashboard-screen' : 'employee-dashboard-screen'; showScreen(s); if (currentUserType === "Client") loadClientDashboard(); else loadEmployeeDashboard();
            });

            document.getElementById('chat-btn-refresh').addEventListener('click', () => { if (currentChamadoId) { showMessage('Atualizando...', false); abrirChat(currentChamadoId); } });
            function handleGridClick(event) { if (event.target && event.target.classList.contains('grid-clickable-cell')) { const chamadoId = event.target.closest('tr').dataset.id; if (chamadoId) abrirChat(chamadoId); } }
            document.getElementById('my-assigned-grid-body').addEventListener('click', handleGridClick);
            document.getElementById('analyst-ticket-grid-body').addEventListener('click', handleGridClick);
            document.getElementById('client-ticket-grid-body').addEventListener('click', handleGridClick);
            document.getElementById('report-recentes-body').addEventListener('click', handleGridClick);
            function handleGridStatusChange(event) { if (event.target && event.target.classList.contains('status-select')) { handleStatusChange(event.target); } }
            document.getElementById('my-assigned-grid-body').addEventListener('change', handleGridStatusChange);
            document.getElementById('analyst-ticket-grid-body').addEventListener('change', handleGridStatusChange);

            // --- Listeners de Submit de Formulário ---
            document.getElementById('chat-message-form').addEventListener('submit', async function (ev) { ev.preventDefault(); const i = document.getElementById('chat-message-input'); const c = i.value.trim(); if (!c || !currentChamadoId || !currentUserType) return; disableForm('chat-message-form', true); const ov = c; i.value = ''; try { const r = await fetchAutenticado(`${API_URL}/api/Chamado/${currentChamadoId}/mensagem`, { method: 'POST', body: JSON.stringify({ Conteudo: c, TipoRemetente: currentUserType }) }); if (!r.ok) { const ed = await r.json(); throw new Error(ed.message || `Erro ${r.status}.`); } const ms = await r.json(); renderizarMensagens(ms); } catch (e) { console.error(e); if (e.message !== "Sessão expirada.") showMessage(`Falha: ${e.message}`, true); i.value = ov; } finally { disableForm('chat-message-form', false); } });
            document.getElementById('btn-save-analyst-changes').addEventListener('click', async () => { if (!currentChamadoId || currentUserType !== 'Employee') return; disableForm('analyst-controls', true); const s = document.getElementById('analyst-select-status').value; const p = document.getElementById('analyst-select-priority').value; const aidV = document.getElementById('analyst-select-assignee').value; const aid = aidV ? parseInt(aidV, 10) : null; const d = { Status: s, Prioridade: p, AnalistaId: aid }; try { const r = await fetchAutenticado(`${API_URL}/api/Chamado/${currentChamadoId}/atualizar`, { method: 'PUT', body: JSON.stringify(d) }); if (!r.ok) { const ed = await r.json(); throw new Error(ed.message || `Erro ${r.status}.`); } showMessage('Salvo!', false); abrirChat(currentChamadoId); } catch (e) { console.error(e); if (e.message !== "Sessão expirada.") showMessage(`Erro: ${e.message}`, true); } finally { disableForm('analyst-controls', false); } });
            document.getElementById('client-ticket-form').addEventListener('submit', async function (ev) { ev.preventDefault(); showMessage('', false); const iI = document.getElementById('ticket-imagens'); const imgs = iI.files; if (imgs.length > MAX_TOTAL_FILES) { showMessage(`Máx ${MAX_TOTAL_FILES} arquivos.`, true); iI.value = ''; return; } for (let i = 0; i < imgs.length; i++) { if (imgs[i].size > MAX_FILE_SIZE_MB * 1024 * 1024) { showMessage(`"${imgs[i].name}" > ${MAX_FILE_SIZE_MB}MB.`, true); iI.value = ''; return; } } disableForm('client-ticket-form', true); const fd = new FormData(); fd.append('Titulo', document.getElementById('ticket-titulo').value); fd.append('Descricao', document.getElementById('ticket-descricao').value); for (let i = 0; i < imgs.length; i++) { fd.append('Imagens', imgs[i]); } try { const r = await fetchAutenticado(`${API_URL}/api/Chamado/criar`, { method: 'POST', body: fd }); if (r.status === 201) { const n = await r.json(); document.getElementById('client-ticket-form').reset(); loadClientDashboard(); showClientTab('client-lista'); abrirChat(n.id); } else { const err = await r.json(); throw new Error(err.message || `Erro ${r.status}.`); } } catch (e) { console.error(e); if (e.message !== "Sessão expirada.") showMessage(`Falha: ${e.message}`, true); } finally { disableForm('client-ticket-form', false); } });
            document.getElementById('login-form').addEventListener('submit', async function (event) {
                event.preventDefault(); showMessage('', false); disableForm('login-form', true); const d = { email: document.getElementById('login-email').value, password: document.getElementById('login-password').value };
                try {
                    const r = await fetch(`${API_URL}/api/Auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(d) }); const res = await r.json(); if (!r.ok) { throw new Error(res.message || `Erro ${r.status}.`); } if (!res.token || !res.userName) throw new Error("Resposta de login incompleta.");
                    localStorage.setItem('jwtToken', res.token);
                    localStorage.setItem('userName', res.userName);
                    localStorage.setItem('isAdmin', res.isAdmin);
                    localStorage.setItem('userType', res.userType); // <-- ALTERAÇÃO: Salva o tipo de usuário
                    currentUserType = res.userType;
                    currentUserIsAdmin = res.isAdmin;
                    document.getElementById('login-form').reset();
                    if (currentUserType === "Client") { showScreen('client-dashboard-screen'); loadClientDashboard(); }
                    else if (currentUserType === "Employee") { showScreen('employee-dashboard-screen'); loadEmployeeDashboard(); }
                    else { throw new Error('Tipo user desconhecido.'); }
                } catch (e) { console.error(e); if (e.name === 'SyntaxError' && e.message.includes('Unexpected token')) { showMessage('Falha: Erro interno no servidor (500). Verifique o console do back-end.', true); } else { showMessage(`Falha: ${e.message}`, true); } } finally { disableForm('login-form', false); }
            });
            document.getElementById('client-register-form').addEventListener('submit', async function (e) {
                e.preventDefault(); showMessage('', false); disableForm('client-register-form', true); const p = document.getElementById('client-password').value; const cp = document.getElementById('client-confirm-password').value; if (p !== cp) { showMessage('Senhas não conferem.', true); disableForm('client-register-form', false); return; } const data = { name: document.getElementById('client-name').value, email: document.getElementById('client-email').value, cpf: document.getElementById('client-cpf').value, password: p, confirmPassword: cp };
                try {
                    const r = await fetch(`${API_URL}/api/Registration/client`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); const res = await r.json(); if (!r.ok) { const errorMsg = (res.errors && res.errors[0]) ? res.errors[0] : (res.message || `Erro ${r.status}`); throw new Error(errorMsg); } showMessage('Cadastrado! Faça login.', false); showScreen('login-screen'); document.getElementById('client-register-form').reset();
                } catch (e) { console.error(`Erro (client-register):`, e); showMessage(`Falha: ${e.message}`, true); } finally { disableForm('client-register-form', false); }
            });
            async function handleMudarSenha(event) {
                event.preventDefault(); showMessage('', false); const formId = event.target.id; let prefix = (formId === 'mudar-senha-form-client') ? 'client-' : 'employee-';
                const senhaAntiga = document.getElementById(`${prefix}senha-antiga`).value; const novaSenha = document.getElementById(`${prefix}nova-senha`).value; const confirmarNovaSenha = document.getElementById(`${prefix}confirmar-nova-senha`).value;
                if (novaSenha !== confirmarNovaSenha) { showMessage('A nova senha e a confirmação não conferem.', true); return; }
                disableForm(formId, true);
                const data = { SenhaAntiga: senhaAntiga, NovaSenha: novaSenha, ConfirmarNovaSenha: confirmarNovaSenha };
                try {
                    const r = await fetchAutenticado(`${API_URL}/api/auth/mudar-senha`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); const res = await r.json();
                    if (!r.ok) { const errorMsg = (res.errors && res.errors[0]) ? res.errors[0] : (res.message || `Erro ${r.status}`); throw new Error(errorMsg); }
                    showMessage('Senha alterada com sucesso!', false); event.target.reset();
                } catch (e) {
                    console.error("Erro ao alterar senha:", e); if (e.message !== "Sessão expirada.") { showMessage(`Falha: ${e.message}`, true); }
                } finally { disableForm(formId, false); }
            }
            document.getElementById('mudar-senha-form-client').addEventListener('submit', handleMudarSenha);
            document.getElementById('mudar-senha-form-employee').addEventListener('submit', handleMudarSenha);
            document.getElementById('admin-reset-password-form').addEventListener('submit', async function (event) {
                event.preventDefault(); showMessage('', false); const formId = 'admin-reset-password-form'; const p = document.getElementById('admin-reset-nova-senha').value; const cp = document.getElementById('admin-reset-confirmar-nova-senha').value;
                if (p !== cp) { showMessage('A nova senha e a confirmação não conferem.', true); return; }
                disableForm(formId, true);
                const data = { Email: document.getElementById('admin-reset-email').value, NovaSenha: p, ConfirmarNovaSenha: cp };
                try {
                    const r = await fetchAutenticado(`${API_URL}/api/auth/admin-reset-password`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); const res = await r.json();
                    if (!r.ok) { const errorMsg = (res.errors && res.errors[0]) ? res.errors[0] : (res.message || `Erro ${r.status}`); throw new Error(errorMsg); }
                    showMessage(res.message, false); document.getElementById(formId).reset();
                } catch (e) {
                    console.error("Erro ao redefinir senha:", e); if (e.message !== "Sessão expirada.") { showMessage(`Falha: ${e.message}`, true); }
                } finally { disableForm(formId, false); }
            });

            // --- NOVO: Funções de Gerenciamento de Funcionários ---
            const adminForm = document.getElementById('admin-register-form');
            const adminFormTitle = document.getElementById('admin-form-title');
            const adminFormDesc = document.getElementById('admin-form-desc');
            const adminFormSubmitBtn = document.getElementById('admin-submit-button');
            const adminFormCancelBtn = document.getElementById('btn-cancel-edit');
            const adminEditingUserId = document.getElementById('admin-editing-user-id');
            const adminPasswordGroup = document.getElementById('admin-password-group');
            const adminEmailInput = document.getElementById('admin-email');
            const adminPasswordInput = document.getElementById('admin-password');
            const adminConfirmPasswordInput = document.getElementById('admin-confirm-password');

            // 1. Carrega a lista de funcionários
            async function loadEmployeeList() {
                const listBody = document.getElementById('employee-list-body');
                if (!listBody) return;
                listBody.innerHTML = `<tr><td colspan="5" class="db-loading" style="text-align: center;">Carregando...</td></tr>`;

                try {
                    const r = await fetchAutenticado(EMPLOYEE_API_URL); // GET /api/employee
                    if (!r.ok) { const e = await r.json(); throw new Error(e.message || `Erro ${r.status}`); }

                    const employees = await r.json();
                    employeeListCache = employees; // Salva no cache para edição
                    listBody.innerHTML = '';

                    if (!employees || employees.length === 0) {
                        listBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Nenhum funcionário cadastrado.</td></tr>`;
                        return;
                    }

                    employees.forEach(emp => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                                        <td>${emp.name}</td>
                                        <td>${emp.email}</td>
                                        <td>${emp.role}</td>
                                        <td>${emp.isAdmin ? 'Sim' : 'Não'}</td>
                                        <td>
                                            <button class="btn-grid-edit" data-id="${emp.id}">Editar</button>
                                            <button class="btn-grid-delete" data-id="${emp.id}">Excluir</button>
                                        </td>
                                    `;
                        listBody.appendChild(tr);
                    });
                } catch (e) {
                    console.error("Erro ao carregar lista de funcionários:", e);
                    if (e.message !== "Sessão expirada.") {
                        listBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">Erro ao carregar: ${e.message}</td></tr>`;
                    }
                }
            }

            // 2. Reseta o formulário de admin para o modo "Cadastrar"
            function resetAdminForm() {
                adminForm.reset();
                adminEditingUserId.value = '';
                adminFormTitle.textContent = 'Cadastrar Novo Funcionário';
                adminFormDesc.style.display = 'block';
                adminFormSubmitBtn.textContent = 'Cadastrar Novo Funcionário';
                adminFormSubmitBtn.classList.remove('btn-success');
                adminFormCancelBtn.classList.add('hidden');

                // Mostra e habilita campos de senha e e-mail
                adminPasswordGroup.style.display = 'block';
                adminEmailInput.disabled = false;
                adminPasswordInput.required = true;
                adminConfirmPasswordInput.required = true;
            }

            // 3. Listener para o formulário de Admin (Criação e Edição)
            adminForm.addEventListener('submit', async function (event) {
                event.preventDefault();
                showMessage('', false);
                const formId = 'admin-register-form';

                const editingId = adminEditingUserId.value;
                const isEditing = !!editingId; // Converte para booleano (true se tiver ID)

                let data;
                let url;
                let method;

                if (isEditing) {
                    // --- MODO EDIÇÃO ---
                    method = 'PUT';
                    url = `${EMPLOYEE_API_URL}/${editingId}`; // PUT /api/employee/{id}
                    data = {
                        name: document.getElementById('admin-name').value,
                        role: document.getElementById('admin-role').value,
                        isAdmin: document.getElementById('admin-is-admin').checked
                    };

                    // Validação de senha não é necessária na edição
                } else {
                    // --- MODO CRIAÇÃO ---
                    method = 'POST';
                    url = `${API_URL}/api/Registration/employee`; // POST /api/Registration/employee
                    const p = document.getElementById('admin-password').value;
                    const cp = document.getElementById('admin-confirm-password').value;

                    if (p !== cp) {
                        showMessage('Senhas não conferem.', true);
                        return;
                    }
                    data = {
                        name: document.getElementById('admin-name').value,
                        email: document.getElementById('admin-email').value,
                        role: document.getElementById('admin-role').value,
                        password: p,
                        confirmPassword: cp,
                        isAdmin: document.getElementById('admin-is-admin').checked
                    };
                }

                disableForm(formId, true);

                try {
                    const r = await fetchAutenticado(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    const res = await r.json();
                    if (!r.ok) {
                        const errorMsg = (res.errors && res.errors[0]) ? res.errors[0] : (res.message || `Erro ${r.status}`);
                        throw new Error(errorMsg);
                    }

                    const successMessage = isEditing ? 'Funcionário atualizado com sucesso!' : 'Funcionário registrado com sucesso!';
                    showMessage(successMessage, false);
                    resetAdminForm();
                    await loadEmployeeList(); // Atualiza a tabela

                } catch (e) {
                    console.error("Erro ao salvar funcionário:", e);
                    if (e.message !== "Sessão expirada.") {
                        showMessage(`Falha: ${e.message}`, true);
                    }
                } finally {
                    disableForm(formId, false);
                }
            });

            // 4. Listener para a tabela de funcionários (Editar e Excluir)
            document.getElementById('employee-list-body').addEventListener('click', async function (event) {
                const target = event.target;
                const id = target.dataset.id;
                if (!id) return;

                // --- AÇÃO DE EXCLUIR ---
                if (target.classList.contains('btn-grid-delete')) {
                    if (!confirm(`Tem certeza de que deseja excluir o funcionário ID ${id}? Esta ação não pode ser desfeita.`)) {
                        return;
                    }
                    showMessage('Excluindo...', false);
                    try {
                        const r = await fetchAutenticado(`${EMPLOYEE_API_URL}/${id}`, { method: 'DELETE' });
                        const res = await r.json();
                        if (!r.ok) { throw new Error(res.message || `Erro ${r.status}`); }

                        showMessage('Funcionário excluído com sucesso!', false);
                        await loadEmployeeList(); // Atualiza a tabela

                    } catch (e) {
                        console.error("Erro ao excluir:", e);
                        if (e.message !== "Sessão expirada.") { showMessage(`Falha ao excluir: ${e.message}`, true); }
                    }
                }

                // --- AÇÃO DE EDITAR ---
                if (target.classList.contains('btn-grid-edit')) {
                    // Encontra o usuário no cache
                    const user = employeeListCache.find(u => u.id == id);
                    if (!user) {
                        showMessage('Erro: Não foi possível encontrar os dados deste usuário.', true);
                        return;
                    }

                    // Preenche o formulário
                    adminFormTitle.textContent = `Editando: ${user.name}`;
                    adminFormDesc.style.display = 'none'; // Esconde descrição
                    adminEditingUserId.value = user.id;

                    document.getElementById('admin-name').value = user.name;
                    document.getElementById('admin-email').value = user.email;
                    document.getElementById('admin-role').value = user.role;
                    document.getElementById('admin-is-admin').checked = user.isAdmin;

                    // Desabilita e-mail (não pode ser alterado)
                    adminEmailInput.disabled = true;

                    // Esconde e desabilita campos de senha (são tratados no reset)
                    adminPasswordGroup.style.display = 'none';
                    adminPasswordInput.required = false;
                    adminConfirmPasswordInput.required = false;

                    // Ajusta os botões
                    adminFormSubmitBtn.textContent = 'Salvar Alterações';
                    adminFormSubmitBtn.classList.add('btn-success');
                    adminFormCancelBtn.classList.remove('hidden');

                    // Rola a página para o formulário
                    adminForm.scrollIntoView({ behavior: 'smooth' });
                }
            });

            // 5. Listener para o botão "Cancelar Edição"
            adminFormCancelBtn.addEventListener('click', resetAdminForm);

            // --- FIM NOVO ---


            // Listener de Registro de Cliente (sem alteração)
            document.getElementById('client-register-form').addEventListener('submit', async function (e) {
                e.preventDefault(); showMessage('', false); disableForm('client-register-form', true); const p = document.getElementById('client-password').value; const cp = document.getElementById('client-confirm-password').value; if (p !== cp) { showMessage('Senhas não conferem.', true); disableForm('client-register-form', false); return; } const data = { name: document.getElementById('client-name').value, email: document.getElementById('client-email').value, cpf: document.getElementById('client-cpf').value, password: p, confirmPassword: cp };
                try {
                    const r = await fetch(`${API_URL}/api/Registration/client`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); const res = await r.json(); if (!r.ok) { const errorMsg = (res.errors && res.errors[0]) ? res.errors[0] : (res.message || `Erro ${r.status}`); throw new Error(errorMsg); } showMessage('Cadastrado! Faça login.', false); showScreen('login-screen'); document.getElementById('client-register-form').reset();
                } catch (e) { console.error(`Erro (client-register):`, e); showMessage(`Falha: ${e.message}`, true); } finally { disableForm('client-register-form', false); }
            });

            // Listener para os formulários de Mudar Senha
            async function handleMudarSenha(event) {
                event.preventDefault(); showMessage('', false); const formId = event.target.id; let prefix = (formId === 'mudar-senha-form-client') ? 'client-' : 'employee-';
                const senhaAntiga = document.getElementById(`${prefix}senha-antiga`).value; const novaSenha = document.getElementById(`${prefix}nova-senha`).value; const confirmarNovaSenha = document.getElementById(`${prefix}confirmar-nova-senha`).value;
                if (novaSenha !== confirmarNovaSenha) { showMessage('A nova senha e a confirmação não conferem.', true); return; }
                disableForm(formId, true);
                const data = { SenhaAntiga: senhaAntiga, NovaSenha: novaSenha, ConfirmarNovaSenha: confirmarNovaSenha };
                try {
                    const r = await fetchAutenticado(`${API_URL}/api/auth/mudar-senha`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); const res = await r.json();
                    if (!r.ok) { const errorMsg = (res.errors && res.errors[0]) ? res.errors[0] : (res.message || `Erro ${r.status}`); throw new Error(errorMsg); }
                    showMessage('Senha alterada com sucesso!', false); event.target.reset();
                } catch (e) {
                    console.error("Erro ao alterar senha:", e); if (e.message !== "Sessão expirada.") { showMessage(`Falha: ${e.message}`, true); }
                } finally { disableForm(formId, false); }
            }
            document.getElementById('mudar-senha-form-client').addEventListener('submit', handleMudarSenha);
            document.getElementById('mudar-senha-form-employee').addEventListener('submit', handleMudarSenha);

            // Listener para o formulário de Admin Reset Password
            document.getElementById('admin-reset-password-form').addEventListener('submit', async function (event) {
                event.preventDefault(); showMessage('', false); const formId = 'admin-reset-password-form'; const p = document.getElementById('admin-reset-nova-senha').value; const cp = document.getElementById('admin-reset-confirmar-nova-senha').value;
                if (p !== cp) { showMessage('A nova senha e a confirmação não conferem.', true); return; }
                disableForm(formId, true);
                const data = { Email: document.getElementById('admin-reset-email').value, NovaSenha: p, ConfirmarNovaSenha: cp };
                try {
                    const r = await fetchAutenticado(`${API_URL}/api/auth/admin-reset-password`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); const res = await r.json();
                    if (!r.ok) { const errorMsg = (res.errors && res.errors[0]) ? res.errors[0] : (res.message || `Erro ${r.status}`); throw new Error(errorMsg); }
                    showMessage(res.message, false); document.getElementById(formId).reset();
                } catch (e) {
                    console.error("Erro ao redefinir senha:", e); if (e.message !== "Sessão expirada.") { showMessage(`Falha: ${e.message}`, true); }
                } finally { disableForm(formId, false); }
            });

            // Sugestões de FAQ (sem alteração)
            async function buscarSugestoesFaq() { const t = document.getElementById('ticket-titulo').value; const d = document.getElementById('ticket-descricao').value; const sC = document.getElementById('faq-sugestoes-container'); const sL = document.getElementById('faq-sugestoes-list'); if (!sC || !sL) return; sL.innerHTML = ''; sC.style.display = 'none'; if ((t.trim().length + d.trim().length) < 5) return; try { const r = await fetch(`${API_URL}/api/Faq/sugerir`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ Titulo: t, Descricao: d }) }); if (!r.ok) { console.error('Erro sugestões:', r.status); return; } const s = await r.json(); if (s && s.length > 0) { s.forEach(f => { const li = document.createElement('li'); const a = document.createElement('a'); a.href = '#'; a.textContent = f.pergunta; a.title = f.resposta; a.onclick = (e) => { e.preventDefault(); alert(`Resposta:\n\n${f.resposta}`); }; li.appendChild(a); sL.appendChild(li); }); sC.style.display = 'block'; } } catch (e) { console.error('Erro rede sugestões:', e); } }
            function debounceBuscarSugestoes() { clearTimeout(faqSuggestionTimeoutId); faqSuggestionTimeoutId = setTimeout(buscarSugestoesFaq, 750); }
            document.getElementById('ticket-titulo').addEventListener('input', debounceBuscarSugestoes);
            document.getElementById('ticket-descricao').addEventListener('input', debounceBuscarSugestoes);

            console.log("Portal NextLayer (com CRUD de Admin) inicializado.");

            checkExistingSession(); // <-- ALTERAÇÃO: Verifica se já existe uma sessão ao carregar a página

        }); // --- FIM DO DOMContentLoaded ---
        /* --- FIM DO JAVASCRIPT --- */
    </script>

</body>
</html>
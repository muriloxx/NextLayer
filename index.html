<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextLayer - Portal</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- INÍCIO DO CSS --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 2rem 0;
        }

        .container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 600px;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .screen {
            display: none;
        }
            /* Esconde todas as telas por padrão */
            .screen.active {
                display: block;
            }
        /* Mostra apenas a tela ativa */
        h2 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 1.5rem;
        }

        h3 {
            margin-top: 1.5rem;
            color: #333;
        }

        .form-group {
            margin-bottom: 1rem;
        }

            .form-group label {
                display: block;
                margin-bottom: 0.5rem;
                color: #555;
                font-weight: 500;
            }

            .form-group input, .form-group textarea, .form-group select {
                width: 100%;
                padding: 0.75rem;
                box-sizing: border-box;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 1rem;
            }

                .form-group input[type="file"] {
                    padding: 0.3rem;
                    border: none;
                }

        .btn {
            width: 100%;
            padding: 0.85rem;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 1rem;
        }

            .btn:hover {
                background-color: #0056b3;
            }

            .btn:disabled {
                background-color: #a0cfff;
                cursor: not-allowed;
            }

        .nav-links {
            text-align: center;
            margin-top: 1.5rem;
        }

        .nav-link {
            color: #007bff;
            cursor: pointer;
            margin: 0 0.5rem;
            text-decoration: none;
        }

            .nav-link:hover {
                text-decoration: underline;
            }

        #message-area {
            text-align: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 4px;
            display: none;
            word-wrap: break-word;
        }

            #message-area.success {
                background-color: #d4edda;
                color: #155724;
                display: block;
            }

            #message-area.error {
                background-color: #f8d7da;
                color: #721c24;
                display: block;
            }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

            .header h2 {
                margin: 0;
                padding: 0;
                text-align: left;
                flex-grow: 1;
                font-size: 1.5rem;
            }

                .header h2 .user-name {
                    font-weight: 400;
                    color: #555;
                    font-size: 0.9em;
                    margin-left: 8px;
                }

        .btn-action {
            background: none;
            border: 1px solid #007bff;
            color: #007bff;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 0.5rem;
            flex-shrink: 0;
        }

            .btn-action:hover {
                background-color: #e7f3ff;
            }

        .btn-logout {
            background: none;
            border: 1px solid #dc3545;
            color: #dc3545;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 0.5rem;
            flex-shrink: 0;
        }

            .btn-logout:hover {
                background-color: #f8d7da;
            }

        .btn-back {
            background: none;
            border: 1px solid #6c757d;
            color: #6c757d;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }

            .btn-back:hover {
                background-color: #e9ecef;
            }

        .ticket-grid-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .ticket-grid {
            width: 100%;
            border-collapse: collapse;
        }

            .ticket-grid th, .ticket-grid td {
                border-bottom: 1px solid #ddd;
                padding: 0.75rem;
                text-align: left;
                vertical-align: top;
            }

            .ticket-grid th {
                background-color: #f9f9f9;
                position: sticky;
                top: 0;
                z-index: 1;
            }

            .ticket-grid tbody tr {
                cursor: default;
            }

                .ticket-grid tbody tr:hover {
                    background-color: #f0f8ff;
                }

        .grid-clickable-cell {
            cursor: pointer;
            text-decoration: underline;
            color: #0056b3;
        }

        .ticket-grid td:last-child, .ticket-grid th:last-child {
            padding-right: 1rem;
        }

        .ticket-grid td:first-child, .ticket-grid th:first-child {
            padding-left: 1rem;
        }

        .status-select {
            padding: 0.3rem 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            font-size: 0.9em;
            cursor: pointer;
        }

            .status-select:disabled {
                background-color: #e9ecef;
                cursor: not-allowed;
                opacity: 0.7;
            }

        #analyst-controls {
            display: none;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            background-color: #f9f9f9;
        }

            #analyst-controls h4 {
                margin-top: 0;
                margin-bottom: 1rem;
                color: #333;
            }

        .analyst-controls-grid {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

            .analyst-controls-grid .form-group {
                flex: 1;
                min-width: 150px;
                margin-bottom: 0.5rem;
            }

        #btn-save-analyst-changes {
            width: auto;
            padding: 0.5rem 1.5rem;
            margin-top: 0.5rem;
            background-color: #28a745;
            border-color: #28a745;
        }

            #btn-save-analyst-changes:hover {
                background-color: #218838;
            }

            #btn-save-analyst-changes:disabled {
                background-color: #94d3a2;
                cursor: not-allowed;
            }

        .chat-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 1.5rem;
        }

        .chat-header {
            background-color: #f9f9f9;
            padding: 1rem;
            border-bottom: 1px solid #ddd;
        }

            .chat-header h4 {
                margin: 0;
                color: #333;
            }

            .chat-header span {
                font-size: 0.9rem;
                color: #666;
                display: block;
                margin-top: 0.2rem;
            }

        .anexos-list {
            padding: 0.5rem 1rem 1rem 1rem;
            border-bottom: 1px solid #eee;
            background-color: #fdfdfd;
        }

            .anexos-list strong {
                font-size: 0.9rem;
                color: #555;
            }

            .anexos-list ul {
                list-style: none;
                padding-left: 0;
                margin: 0.5rem 0 0 0;
            }

            .anexos-list li {
                margin-bottom: 0.3rem;
            }

                .anexos-list li a {
                    text-decoration: none;
                    color: #007bff;
                    font-size: 0.9rem;
                    word-break: break-all;
                }

                    .anexos-list li a:hover {
                        text-decoration: underline;
                    }

        .chat-messages {
            height: 350px;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f5f5f5;
        }

        .chat-input-form {
            display: flex;
            border-top: 1px solid #ddd;
        }

            .chat-input-form input {
                flex-grow: 1;
                border: none;
                padding: 1rem;
                border-radius: 0 0 0 4px;
                outline: none;
                font-size: 1rem;
            }

            .chat-input-form button {
                border: none;
                background-color: #007bff;
                color: white;
                padding: 0 1.5rem;
                cursor: pointer;
                border-radius: 0 0 4px 0;
                font-size: 1rem;
                flex-shrink: 0;
            }

                .chat-input-form button:hover {
                    background-color: #0056b3;
                }

                .chat-input-form button:disabled {
                    background-color: #a0cfff;
                    cursor: not-allowed;
                }

        .chat-message {
            margin-bottom: 1rem;
            max-width: 80%;
            display: flex;
            flex-direction: column;
        }

            .chat-message .sender {
                font-weight: bold;
                font-size: 0.85rem;
                color: #333;
                margin-bottom: 0.2rem;
                display: block;
            }

            .chat-message .timestamp {
                font-size: 0.75rem;
                color: #999;
                margin-left: 0.5rem;
            }

            .chat-message .content {
                padding: 0.75rem;
                border-radius: 8px;
                margin-top: 0.25rem;
                word-wrap: break-word;
                line-height: 1.4;
            }

            .chat-message.other {
                align-items: flex-start;
                margin-right: auto;
            }

                .chat-message.other .sender {
                    text-align: left;
                }

            .chat-message.viewer {
                align-items: flex-end;
                margin-left: auto;
            }

                .chat-message.viewer .sender {
                    text-align: right;
                }

                .chat-message.viewer .content {
                    background-color: #007bff;
                    color: white;
                }

            .chat-message.other.client .content {
                background-color: #e9ecef;
                color: #333;
            }

            .chat-message.other.ia .content {
                background-color: #f8f9fa;
                border: 1px solid #e9ecef;
                color: #444;
            }

            .chat-message.other.analyst .content {
                background-color: #d1ecf1;
                color: #0c5460;
            }

        .tab-nav {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .tab-link {
            padding: 0.75rem 1.25rem;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-size: 1rem;
            color: #495057;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

            .tab-link:hover {
                background-color: #f8f9fa;
                border-bottom-color: #e9ecef;
            }

            .tab-link.active {
                color: #007bff;
                font-weight: 600;
                border-bottom-color: #007bff;
            }

        .tab-content {
            display: none;
        }

            .tab-content.active {
                display: block;
            }

        #dashboard-stats-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            background-color: #fdfdfd;
        }

        .stats-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: center;
        }

        .stats-numeros {
            flex: 1 1 150px;
        }

            .stats-numeros ul {
                list-style: none;
                padding-left: 0;
                margin: 0;
            }

            .stats-numeros li {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem;
                border-bottom: 1px solid #eee;
            }

                .stats-numeros li .stat-label {
                    font-size: 0.9rem;
                    color: #333;
                }

                .stats-numeros li .stat-count {
                    font-size: 1.2rem;
                    font-weight: bold;
                    color: #0056b3;
                }

        .stats-grafico {
            flex: 1 1 200px;
            max-width: 300px;
            margin: 0 auto;
        }

        #stats-chart-canvas {
            max-width: 100%;
            height: auto;
        }
        /* --- FIM DO CSS --- */
    </style>
</head>
<body>

    <div class="container">
        <div id="message-area"></div>

        <div id="login-screen" class="screen active">
            <h2>NextLayer Login</h2>
            <form id="login-form">
                <div class="form-group"> <label for="login-email">E-mail</label> <input type="email" id="login-email" required autocomplete="email"> </div>
                <div class="form-group"> <label for="login-password">Senha</label> <input type="password" id="login-password" required autocomplete="current-password"> </div>
                <button type="submit" class="btn">Entrar</button>
            </form>
            <div class="nav-links">
                <span class="nav-link" id="nav-to-client-register">Cadastrar Cliente</span>
                <span class="nav-link" id="nav-to-employee-register">Cadastrar Funcionário</span>
            </div>
        </div>

        <div id="client-register-screen" class="screen">
            <h2>Cadastro de Cliente</h2>
            <form id="client-register-form">
                <div class="form-group"> <label for="client-name">Nome Completo</label> <input type="text" id="client-name" required autocomplete="name"> </div>
                <div class="form-group"> <label for="client-email">E-mail</label> <input type="email" id="client-email" required autocomplete="email"> </div>
                <div class="form-group"> <label for="client-cpf">CPF</label> <input type="text" id="client-cpf" required> </div>
                <div class="form-group"> <label for="client-password">Senha (mín. 6)</label> <input type="password" id="client-password" minlength="6" required autocomplete="new-password"> </div>
                <div class="form-group"> <label for="client-confirm-password">Confirmar Senha</label> <input type="password" id="client-confirm-password" required autocomplete="new-password"> </div>
                <button type="submit" class="btn">Cadastrar</button>
            </form>
            <div class="nav-links">
                <span class="nav-link" id="nav-c-to-login">Voltar</span>
            </div>
        </div>

        <div id="employee-register-screen" class="screen">
            <h2>Cadastro de Funcionário</h2>
            <form id="employee-register-form">
                <div class="form-group"> <label for="employee-name">Nome Completo</label> <input type="text" id="employee-name" required autocomplete="name"> </div>
                <div class="form-group"> <label for="employee-email">E-mail Institucional</label> <input type="email" id="employee-email" required autocomplete="email"> </div>
                <div class="form-group"> <label for="employee-role">Cargo</label> <input type="text" id="employee-role" required> </div>
                <div class="form-group"> <label for="employee-password">Senha (mín. 6)</label> <input type="password" id="employee-password" minlength="6" required autocomplete="new-password"> </div>
                <div class="form-group"> <label for="employee-confirm-password">Confirmar Senha</label> <input type="password" id="employee-confirm-password" required autocomplete="new-password"> </div>
                <button type="submit" class="btn">Cadastrar</button>
            </form>
            <div class="nav-links">
                <span class="nav-link" id="nav-e-to-login">Voltar</span>
            </div>
        </div>

        <div id="client-dashboard-screen" class="screen">
            <div class="header"> <h2 id="client-dashboard-title">Portal do Cliente</h2> <button class="btn-logout" id="logout-client">Sair</button> </div>
            <h3>Abrir Novo Chamado</h3>
            <form id="client-ticket-form">
                <div class="form-group"> <label for="ticket-titulo">Título</label> <input type="text" id="ticket-titulo" required> </div>
                <div class="form-group"> <label for="ticket-descricao">Descrição</label> <textarea id="ticket-descricao" rows="5" required></textarea> </div>
                <div id="faq-sugestoes-container" style="display: none; margin-top: 1rem;"> <strong>Sugestões (FAQ):</strong> <ul id="faq-sugestoes-list" style="margin-top: 0.5rem; padding-left: 20px; list-style: disc;"></ul> </div>
                <div class="form-group" style="margin-top: 1rem;"> <label for="ticket-imagens">Anexos (Opcional)</label> <input type="file" id="ticket-imagens" accept="image/*" multiple> </div>
                <button type="submit" class="btn" id="btn-criar-chamado">Enviar e Abrir Chat</button>
            </form>
            <h3 style="margin-top: 2.5rem; border-top: 1px solid #eee; padding-top: 2rem;">Meus Chamados</h3>
            <div class="ticket-grid-container"> <table class="ticket-grid"> <thead> <tr> <th>Nº</th> <th>Título</th> <th>Abertura</th> <th>Status</th> </tr> </thead> <tbody id="client-ticket-grid-body"></tbody> </table> </div>
        </div>

        <div id="employee-dashboard-screen" class="screen">
            <div class="header"> <h2 id="employee-dashboard-title">Painel do Analista</h2> <button class="btn-logout" id="logout-employee">Sair</button> </div>

            <div class="tab-nav">
                <button class="tab-link active" id="tab-link-reports">Relatórios</button>
                <button class="tab-link" id="tab-link-tickets">Chamados</button>
            </div>

            <div id="tab-content-reports" class="tab-content active">
                <h3 style="margin-top: 1.5rem;">Relatório de Status</h3>
                <div id="dashboard-stats-container">
                    <p id="stats-loading-message" style="color: #666;">Carregando estatísticas...</p>
                </div>
            </div>

            <div id="tab-content-tickets" class="tab-content">
                <h3>Meus Chamados Atribuídos (Não Concluídos)</h3>
                <div class="ticket-grid-container">
                    <table class="ticket-grid">
                        <thead> <tr> <th>Nº</th> <th>Título</th> <th>Cliente</th> <th>Abertura</th> <th>Status</th> </tr> </thead>
                        <tbody id="my-assigned-grid-body"></tbody>
                    </table>
                </div>
                <h3 style="margin-top: 2.5rem; border-top: 1px solid #eee; padding-top: 2rem;">Todos Chamados (Abertos/Em Andamento)</h3>
                <div class="ticket-grid-container"> <table class="ticket-grid"> <thead> <tr> <th>Nº</th> <th>Título</th> <th>Cliente</th> <th>Abertura</th> <th>Status</th> <th>Analista</th> </tr> </thead> <tbody id="analyst-ticket-grid-body"></tbody> </table> </div>
            </div>
        </div>

        <div id="chat-screen" class="screen">
            <div class="header"> <button class="btn-back" id="chat-btn-back">← Voltar</button> <h2 id="chat-header-title">Chat</h2> <button class="btn-action" id="chat-btn-refresh">↻</button> <button class="btn-logout" id="logout-chat">Sair</button> </div>
            <div id="analyst-controls">
                <h4>Controles</h4>
                <div class="analyst-controls-grid">
                    <div class="form-group"> <label for="analyst-select-status">Status</label> <select id="analyst-select-status"> <option value="Aberto (IA)">Aberto (IA)</option> <option value="Aguardando Analista">Aguardando Analista</option> <option value="Em Andamento (Analista)">Em Andamento (Analista)</option> <option value="Aguardando Cliente">Aguardando Cliente</option> <option value="Concluído">Concluído</option> <option value="Encerrado">Encerrado</option> <option value="Cancelado">Cancelado</option> </select> </div>
                    <div class="form-group"> <label for="analyst-select-priority">Prioridade</label> <select id="analyst-select-priority"> <option value="Baixa">Baixa</option> <option value="Média">Média</option> <option value="Alta">Alta</option> </select> </div>
                    <div class="form-group"> <label for="analyst-select-assignee">Analista</label> <select id="analyst-select-assignee"> <option value="">-- Nenhum --</option> </select> </div>
                </div>
                <button class="btn" id="btn-save-analyst-changes">Salvar</button>
            </div>
            <div class="chat-container">
                <div class="chat-header"> <h4 id="chat-titulo">...</h4> <span id="chat-numero">...</span> </div>
                <div class="anexos-list" id="chat-anexos-container" style="display: none;"> <strong>Anexos:</strong> <ul id="chat-anexos-list"></ul> </div>
                <div class="chat-messages" id="chat-messages-area"></div>
                <form class="chat-input-form" id="chat-message-form"> <input type="text" id="chat-message-input" placeholder="..." required autocomplete="off"> <button type="submit" id="btn-enviar-msg">Enviar</button> </form>
            </div>
        </div>
    </div>

    <script>
        /* --- INÍCIO DO JAVASCRIPT --- */

        // --- CORREÇÃO 4: Espera o DOM carregar ---
        document.addEventListener("DOMContentLoaded", function () {

            // --- CONFIGURAÇÃO E VARIÁVEIS GLOBAIS ---
            const API_URL = "https://localhost:7121"; // CONFIRME A PORTA!
            const MAX_FILE_SIZE_MB = 5;
            const MAX_TOTAL_FILES = 5;
            const messageArea = document.getElementById('message-area');
            let currentUserType = null;
            let currentChamadoId = null;
            let faqSuggestionTimeoutId = null;
            let currentChamadoDetails = null;
            let listaAnalistasCache = null;
            let statsChartInstance = null;

            // --- FUNÇÕES AUXILIARES ---

            /** Mostra a tela especificada e esconde as outras */
            function showScreen(screenId) {
                try {
                    document.querySelectorAll('.screen').forEach(screen => {
                        if (screen) screen.classList.remove('active');
                    });
                    const screenToShow = document.getElementById(screenId);
                    if (screenToShow) {
                        screenToShow.classList.add('active');
                    } else {
                        console.error("Tela Inválida:", screenId);
                        document.getElementById('login-screen').classList.add('active'); // Fallback
                    }
                    showMessage('', false);
                    window.scrollTo(0, 0);
                } catch (e) { console.error("Erro em showScreen:", e); }
            }

            /** Exibe uma mensagem global no topo da caixa */
            function showMessage(message, isError = false) {
                if (!messageArea) return;
                try {
                    if (messageArea.timerId) clearTimeout(messageArea.timerId);
                    messageArea.textContent = message;
                    messageArea.className = message ? (isError ? 'error' : 'success') : '';
                    const timeout = isError ? 8000 : 5000;
                    if (message) {
                        messageArea.timerId = setTimeout(() => { showMessage(''); }, timeout);
                    }
                } catch (e) { console.error("Erro em showMessage:", e); }
            }

            /** Formata uma data string ISO para o padrão local PT-BR */
            function formatISODate(isoDateString) {
                if (!isoDateString) return '-';
                try {
                    return new Date(isoDateString).toLocaleString('pt-BR', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                } catch (e) { console.error("Erro formatar data:", isoDateString, e); return isoDateString; }
            }

            /** Desabilita/habilita elementos de formulário dentro de um container (form ou div) */
            function disableForm(formId, disable = true) {
                try {
                    const formOrDiv = document.getElementById(formId);
                    if (!formOrDiv) { console.warn("Elemento não encontrado:", formId); return; }

                    const elements = formOrDiv.querySelectorAll('input, select, textarea, button');
                    elements.forEach(el => { if (el) el.disabled = disable; });

                    let button;
                    if (formId === 'analyst-controls') {
                        button = document.getElementById('btn-save-analyst-changes');
                    } else if (formOrDiv.tagName === 'FORM') {
                        button = formOrDiv.querySelector('button[type="submit"]');
                    } else {
                        return; // Não mexe no texto de outros botões
                    }

                    if (button) {
                        const originalText = button.dataset.originalText || button.textContent;
                        if (disable && !button.dataset.originalText) { button.dataset.originalText = originalText; }
                        const waitText = (formId === 'analyst-controls' ? 'Salvando...' : 'Aguarde...');
                        button.textContent = disable ? waitText : originalText;
                        if (!disable) delete button.dataset.originalText;
                    }

                    const firstInput = formOrDiv.querySelector('input:not([type=hidden]), textarea, select');
                    if (!disable && firstInput && formId !== 'login-form' && formId !== 'chat-message-form') {
                        setTimeout(() => { try { firstInput.focus(); } catch (e) { } }, 100);
                    } else if (!disable && formId === 'chat-message-form') {
                        setTimeout(() => { try { document.getElementById('chat-message-input').focus(); } catch (e) { } }, 100);
                    }
                } catch (e) { console.error("Erro em disableForm:", e, formId); }
            }

            /** Faz logout, limpa variáveis globais e reseta formulários */
            function logout() {
                currentUserType = null; currentChamadoId = null; listaAnalistasCache = null;
                localStorage.removeItem('jwtToken'); // Limpa o token
                localStorage.removeItem('userName'); // Limpa o nome

                try { document.getElementById('analyst-ticket-grid-body').innerHTML = ''; } catch (e) { }
                try { document.getElementById('my-assigned-grid-body').innerHTML = ''; } catch (e) { }
                try { document.getElementById('client-ticket-grid-body').innerHTML = ''; } catch (e) { }
                try {
                    if (statsChartInstance) {
                        statsChartInstance.destroy();
                        statsChartInstance = null;
                    }
                    const statsContainer = document.getElementById('dashboard-stats-container');
                    if (statsContainer) {
                        statsContainer.innerHTML = '<p id="stats-loading-message" style="color: #666;">Carregando...</p>';
                    }
                } catch (e) { }

                ['login-form', 'client-register-form', 'employee-register-form', 'client-ticket-form', 'chat-message-form', 'analyst-controls'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (el.tagName === 'FORM') el.reset();
                        else { try { el.querySelectorAll('select').forEach(s => s.selectedIndex = 0); el.querySelectorAll('input:not([type=hidden])').forEach(i => i.value = ''); } catch (e) { } }
                    }
                });

                try { document.getElementById('client-dashboard-title').textContent = "Portal do Cliente"; } catch (e) { }
                try { document.getElementById('employee-dashboard-title').textContent = "Painel do Analista"; } catch (e) { }

                showScreen('login-screen');
            }

            /** Helper para fazer fetch com autenticação */
            async function fetchAutenticado(url, options = {}) {
                const token = localStorage.getItem('jwtToken');
                const headers = new Headers(options.headers || {});
                if (token) { headers.append('Authorization', `Bearer ${token}`); }
                if (options.body && !(options.body instanceof FormData) && !headers.has('Content-Type')) {
                    headers.append('Content-Type', 'application/json');
                }
                options.headers = headers;
                const response = await fetch(url, options);
                if (response.status === 401) { console.warn("401. Forçando logout."); showMessage("Sessão expirada. Faça login.", true); logout(); throw new Error("Sessão expirada."); }
                if (response.status === 403) { console.warn("403. Proibido."); try { const e = await response.json(); throw new Error(e.message || "Acesso negado."); } catch (e) { throw new Error("Acesso negado."); } }
                return response;
            }

            // --- LÓGICA DE CARREGAMENTO DOS PAINÉIS ---

            /** Carrega Estatísticas e desenha o Gráfico */
            async function loadDashboardStats() {
                const statsContainer = document.getElementById('dashboard-stats-container');
                const loadingMessage = document.getElementById('stats-loading-message');
                if (!statsContainer) { console.error("Contêiner de stats não encontrado."); return; }

                if (statsContainer.querySelector('.stats-layout')) statsContainer.querySelector('.stats-layout').remove();
                if (statsChartInstance) { statsChartInstance.destroy(); statsChartInstance = null; }

                if (loadingMessage) {
                    loadingMessage.textContent = "Carregando estatísticas...";
                    loadingMessage.style.display = 'block';
                } else {
                    statsContainer.innerHTML = '<p id="stats-loading-message" style="color: #666;">Carregando...</p>';
                }

                try {
                    const response = await fetchAutenticado(`${API_URL}/api/Dashboard/stats/por-status`);
                    if (!response.ok) { const e = await response.json(); throw new Error(e.message || `Erro ${response.status}`); }
                    const stats = await response.json();

                    if (loadingMessage) loadingMessage.style.display = 'none';
                    if (!stats || stats.length === 0) {
                        statsContainer.innerHTML = '<p id="stats-loading-message">Nenhuma estatística encontrada.</p>';
                        return;
                    }

                    statsContainer.innerHTML = `
                            <div class="stats-layout">
                                <div class="stats-numeros"><ul id="stats-list"></ul></div>
                                <div class="stats-grafico"><canvas id="stats-chart-canvas"></canvas></div>
                            </div>
                        `;

                    const statsList = document.getElementById('stats-list');
                    let total = 0;
                    stats.forEach(item => {
                        total += item.contagem;
                        statsList.innerHTML += `<li><span class="stat-label">${item.status}</span><span class="stat-count">${item.contagem}</span></li>`;
                    });
                    statsList.innerHTML += `<li style="border-top:2px solid #007bff; margin-top:0.5rem; padding-top:0.5rem;"><span class="stat-label"><strong>Total</strong></span><span class="stat-count"><strong>${total}</strong></span></li>`;

                    if (typeof Chart !== 'undefined') { // Verifica se Chart.js carregou
                        const ctx = document.getElementById('stats-chart-canvas').getContext('2d');
                        statsChartInstance = new Chart(ctx, {
                            type: 'pie', data: { labels: stats.map(i => i.status), datasets: [{ data: stats.map(i => i.contagem), backgroundColor: ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)', 'rgba(100, 100, 100, 0.7)'], borderColor: '#fff', borderWidth: 1 }] },
                            options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Distribuição de Status' } } }
                        });
                    } else {
                        console.error("Chart.js não foi carregado. O gráfico não pode ser renderizado.");
                        document.querySelector('.stats-grafico').innerHTML = `<p style="color:red;">Erro: Biblioteca de gráfico não carregou.</p>`;
                    }
                } catch (error) {
                    console.error("Erro stats:", error);
                    if (error.message !== "Sessão expirada.") {
                        if (loadingMessage) loadingMessage.style.display = 'none';
                        else statsContainer.innerHTML = '';
                        statsContainer.innerHTML += `<p style="color:red;">Erro: ${error.message}</p>`;
                    }
                }
            }

            /** Carrega os grids do Analista (Meus Chamados e Todos) */
            async function loadEmployeeDashboard() {
                try {
                    const userName = localStorage.getItem('userName') || 'Analista';
                    document.getElementById('employee-dashboard-title').innerHTML = `Painel do Analista <span class="user-name">(${userName})</span>`;
                } catch (e) { console.error("Erro setar nome analista:", e); }

                showAnalystTab('reports'); // Mostra relatórios primeiro
                loadDashboardStats();
                loadEmployeeGrids(); // Carrega os grids (não espera)
            }

            /** Função separada para carregar os grids do analista */
            async function loadEmployeeGrids() {
                const myGridBody = document.getElementById('my-assigned-grid-body');
                if (myGridBody) {
                    myGridBody.innerHTML = `<tr><td colspan="5">Carregando...</td></tr>`;
                    try {
                        const response = await fetchAutenticado(`${API_URL}/api/Chamado/meus-chamados-analista`);
                        if (!response.ok) throw new Error(`Erro ${response.status}.`); const chamados = await response.json(); myGridBody.innerHTML = '';
                        if (!chamados || chamados.length === 0) { myGridBody.innerHTML = `<tr><td colspan="5">Nenhum chamado.</td></tr>`; }
                        else {
                            chamados.forEach(c => {
                                const opts = ["Aberto (IA)", "Aguardando Analista", "Em Andamento (Analista)", "Aguardando Cliente", "Concluído", "Encerrado", "Cancelado"];
                                let selHtml = `<select class="status-select" data-id="${c.id}" data-grid-type="my-grid">`; // Adiciona data-grid-type
                                opts.forEach(opt => {
                                    const isSelected = (opt === (c.status || '')) ? 'selected' : '';
                                    selHtml += `<option value="${opt}" ${isSelected}>${opt}</option>`;
                                });
                                selHtml += `</select>`;

                                myGridBody.innerHTML += `<tr data-id="${c.id}">
                                         <td data-action="abrirChat" class="grid-clickable-cell">${c.numeroChamado || '-'}</td>
                                         <td>${c.titulo || '-'}</td>
                                         <td>${c.nomeCliente || '-'}</td>
                                         <td>${formatISODate(c.dataAbertura)}</td> 
                                         <td>${selHtml}</td>  
                                     </tr>`;
                            });
                        }
                    } catch (e) { console.error('Erro meus chamados:', e); if (e.message !== "Sessão expirada.") myGridBody.innerHTML = `<tr><td colspan="5" style="color:red;">${e.message || 'Erro.'}</td></tr>`; }
                }
                const gridBody = document.getElementById('analyst-ticket-grid-body');
                if (!gridBody) return;
                gridBody.innerHTML = `<tr><td colspan="6">Carregando...</td></tr>`;
                try {
                    const response = await fetchAutenticado(`${API_URL}/api/Chamado/abertos`);
                    if (!response.ok) throw new Error(`Erro ${response.status}.`); const chamados = await response.json(); gridBody.innerHTML = '';
                    if (!chamados || chamados.length === 0) { gridBody.innerHTML = `<tr><td colspan="6">Nenhum chamado.</td></tr>`; return; }
                    chamados.forEach(c => {
                        const opts = ["Aberto (IA)", "Aguardando Analista", "Em Andamento (Analista)", "Aguardando Cliente", "Concluído", "Encerrado", "Cancelado"];
                        let selHtml = `<select class="status-select" data-id="${c.id}" data-grid-type="all-grid">`;
                        opts.forEach(opt => {
                            const isSelected = (opt === (c.status || '')) ? 'selected' : ''; // Variável local
                            selHtml += `<option value="${opt}" ${isSelected}>${opt}</option>`;
                        });
                        selHtml += `</select>`;
                        gridBody.innerHTML += `<tr data-id="${c.id}"><td data-action="abrirChat" class="grid-clickable-cell">${c.numeroChamado || '-'}</td><td>${c.titulo || '-'}</td><td>${c.nomeCliente || '-'}</td><td>${formatISODate(c.dataAbertura)}</td><td>${selHtml}</td><td>${c.nomeAnalista || '--'}</td></tr>`;
                    });
                } catch (e) { console.error('Erro todos chamados:', e); if (e.message !== "Sessão expirada.") gridBody.innerHTML = `<tr><td colspan="6" style="color:red;">${e.message || 'Erro.'}</td></tr>`; }
            }

            /** Carrega o grid de chamados para o Cliente */
            async function loadClientDashboard() {
                try {
                    const userName = localStorage.getItem('userName') || 'Cliente';
                    document.getElementById('client-dashboard-title').innerHTML = `Portal do Cliente <span class="user-name">(${userName})</span>`;
                } catch (e) { console.error("Erro setar nome cliente:", e); }
                const gridBody = document.getElementById('client-ticket-grid-body'); if (!gridBody) return;
                gridBody.innerHTML = `<tr><td colspan="4">Carregando...</td></tr>`;
                try {
                    const response = await fetchAutenticado(`${API_URL}/api/Chamado/meuschamados`);
                    if (!response.ok) throw new Error(`Erro ${response.status}.`); const chamados = await response.json(); gridBody.innerHTML = '';
                    if (!chamados || chamados.length === 0) { gridBody.innerHTML = `<tr><td colspan="4">Nenhum chamado.</td></tr>`; return; }
                    chamados.forEach(c => { gridBody.innerHTML += `<tr data-id="${c.id}"><td data-action="abrirChat" class="grid-clickable-cell">${c.numeroChamado || '-'}</td><td data-action="abrirChat" class="grid-clickable-cell">${c.titulo || '-'}</td><td>${formatISODate(c.dataAbertura)}</td><td>${c.status || '-'}</td></tr>`; });
                } catch (e) { console.error('Erro load cliente:', e); if (e.message !== "Sessão expirada.") gridBody.innerHTML = `<tr><td colspan="4" style="color:red;">${e.message || 'Erro.'}</td></tr>`; }
            }

            /** Carrega Analistas no Dropdown */
            async function carregarAnalistasDropdown(selectElementId, selectedAnalistaId = null) {
                const select = document.getElementById(selectElementId); if (!select) { console.error("Dropdown não encontrado:", selectElementId); return; }
                select.options.length = 1;
                try {
                    if (!listaAnalistasCache) {
                        console.log("Buscando analistas da API...");
                        const response = await fetchAutenticado(`${API_URL}/api/Employee/analistas`);
                        if (!response.ok) throw new Error(`Erro ${response.status} buscando analistas.`);
                        listaAnalistasCache = await response.json();
                    }
                    if (listaAnalistasCache && listaAnalistasCache.length > 0) {
                        listaAnalistasCache.forEach(analista => {
                            const option = document.createElement('option'); option.value = analista.id;
                            option.textContent = `${analista.nome} (${analista.funcao || 'N/A'})`;
                            if (selectedAnalistaId && analista.id === selectedAnalistaId) { option.selected = true; }
                            select.appendChild(option);
                        });
                    }
                } catch (error) { console.error("Erro carregar analistas:", error); const option = document.createElement('option'); option.value = ""; option.textContent = "Erro ao carregar"; option.disabled = true; select.appendChild(option); }
            }

            /** Atualiza Status pelo Grid */
            async function handleStatusChange(selectElement) {
                const chamadoId = selectElement.dataset.id; const novoStatus = selectElement.value; if (!chamadoId || !novoStatus) return;
                selectElement.disabled = true; showMessage(`Salvando...`, false); let statusOriginal = '';
                try {
                    const rGet = await fetchAutenticado(`${API_URL}/api/Chamado/${chamadoId}`); if (!rGet.ok) throw new Error(`Erro ${rGet.status}.`);
                    const cAtual = await rGet.json(); statusOriginal = cAtual.status || '';
                    if (!cAtual) throw new Error("Não foi possível carregar dados atuais.");
                    const data = { Status: novoStatus, Prioridade: cAtual.prioridade || 'Média', RoleDesignada: cAtual.roleDesignada || null, AnalistaId: cAtual.analistaId || null };
                    const rPut = await fetchAutenticado(`${API_URL}/api/Chamado/${chamadoId}/atualizar`, { method: 'PUT', body: JSON.stringify(data) });
                    if (!rPut.ok) { const ed = await rPut.json(); throw new Error(ed.message || `Erro ${rPut.status}.`); }
                    showMessage('Status atualizado!', false);

                    // Recarrega ambos os grids do analista
                    loadEmployeeGrids();
                } catch (e) { console.error('Erro status grid:', e); if (e.message !== "Sessão expirada.") showMessage(`Erro: ${e.message}`, true); try { selectElement.value = statusOriginal; } catch (revertError) { } }
                finally { selectElement.disabled = false; }
            }

            // --- LÓGICA DO CHAT ---
            async function abrirChat(chamadoId) {
                if (!chamadoId) return; currentChamadoId = chamadoId; showScreen('chat-screen');
                const controlsDiv = document.getElementById('analyst-controls'); const chatInput = document.getElementById('chat-message-input');
                const tit = document.getElementById('chat-titulo'); const num = document.getElementById('chat-numero'); const anexC = document.getElementById('chat-anexos-container');
                const anexL = document.getElementById('chat-anexos-list'); // CORREÇÃO 4: Define 'anexL'
                const msgA = document.getElementById('chat-messages-area');

                tit.textContent = 'Carregando...'; num.textContent = '...';
                if (anexL) anexL.innerHTML = ''; // Usa 'anexL'
                if (anexC) anexC.style.display = 'none';
                if (msgA) msgA.innerHTML = '<p style="text-align:center; color:#999;">Carregando...</p>';

                disableForm('chat-message-form', true); disableForm('analyst-controls', true); if (controlsDiv) controlsDiv.style.display = 'none'; currentChamadoDetails = null;

                try {
                    const response = await fetchAutenticado(`${API_URL}/api/Chamado/${chamadoId}`); if (!response.ok) throw new Error(`Erro ${response.status}.`);
                    currentChamadoDetails = await response.json(); const c = currentChamadoDetails; console.log("Dados chat:", c); if (!c) throw new Error("Resposta inválida (null).");

                    tit.textContent = c.titulo || 'S/ Título'; num.textContent = `${c.numeroChamado || 'N/A'} (${c.status || 'N/A'})`;
                    if (c.anexos && c.anexos.length > 0) { let html = ''; c.anexos.forEach(a => { if (a.urlArquivo && a.nomeArquivo) { const safe = a.nomeArquivo.replace(/</g, "&lt;").replace(/>/g, "&gt;"); html += `<li><a href="${a.urlArquivo}" target="_blank">${safe}</a></li>`; } }); if (html) { anexL.innerHTML = html; anexC.style.display = 'block'; } }
                    renderizarMensagens(c.mensagens || []);

                    if (currentUserType === 'Employee') {
                        controlsDiv.style.display = 'block';
                        try { document.getElementById('analyst-select-status').value = c.status || ''; } catch (e) { console.warn(e); }
                        try { document.getElementById('analyst-select-priority').value = c.prioridade || 'Média'; } catch (e) { console.warn(e); }
                        await carregarAnalistasDropdown('analyst-select-assignee', c.analistaId);
                        disableForm('analyst-controls', false);
                    }

                    let isBlq = false; if (c.status === 'Encerrado') { isBlq = true; } else if (c.status === 'Concluído' && c.dataConclusao) { try { const dC = new Date(c.dataConclusao); const ag = new Date(); const dH = (ag - dC) / 36e5; if (dH > 72) isBlq = true; } catch (e) { console.error(e); } }
                    if (currentUserType === 'Client' && isBlq) { chatInput.placeholder = "Chamado encerrado."; showMessage("Chamado encerrado.", true); disableForm('chat-message-form', true); }
                    else { chatInput.placeholder = "Digite sua mensagem..."; disableForm('chat-message-form', false); }
                } catch (e) { console.error('Erro abrir chat:', e); if (e.message !== "Sessão expirada.") showMessage(`Erro chat: ${e.message}`, true); msgA.innerHTML = `<p style="color:red;">Falha ao carregar dados.</p>`; }
            }

            /** Renderiza as mensagens na tela de chat */
            function renderizarMensagens(mensagens) {
                const area = document.getElementById('chat-messages-area'); if (!area) return; area.innerHTML = '';
                if (!mensagens || mensagens.length === 0) { area.innerHTML = `<p style="text-align:center; color:#999;">Sem mensagens.</p>`; return; }
                try {
                    mensagens.forEach(msg => {
                        if (!msg) { console.warn("Msg inválida:", msg); return; }
                        const d = formatISODate(msg.dataEnvio); let rc = '', ac = '';
                        const t = msg.tipoRemetente || 'IA'; const u = currentUserType || 'Client';
                        if (t === 'Client') rc = 'client'; else if (t === 'Employee') rc = 'analyst'; else rc = 'ia';
                        if ((t === 'Client' && u === 'Client') || (t === 'Employee' && u === 'Employee')) { ac = 'viewer'; } else { ac = 'other'; }
                        const sC = (msg.conteudo || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        const sS = (msg.remetenteNome || 'Desc.').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        area.innerHTML += `<div class="chat-message ${ac} ${rc}"><span class="sender">${sS}<span class="timestamp">${d}</span></span><div class="content">${sC}</div></div>`;
                    });
                    setTimeout(() => { area.scrollTop = area.scrollHeight; }, 50);
                } catch (err) { console.error("Erro renderizar:", err, mensagens); area.innerHTML = `<p style="color:red;">Erro exibir msgs.</p>`; }
            }

            /** Função para mostrar Abas do Analista */
            function showAnalystTab(tabName) {
                try {
                    document.querySelectorAll('#employee-dashboard-screen .tab-content').forEach(content => content.classList.remove('active'));
                    document.querySelectorAll('#employee-dashboard-screen .tab-link').forEach(link => link.classList.remove('active'));
                    document.getElementById(`tab-content-${tabName}`).classList.add('active');
                    document.getElementById(`tab-link-${tabName}`).classList.add('active');
                } catch (e) { console.error("Erro ao trocar de aba:", e); }
            }

            // --- EVENT LISTENERS ---

            // CORREÇÃO 2: Anexa listeners das abas usando JS
            document.getElementById('tab-link-reports').addEventListener('click', () => showAnalystTab('reports'));
            document.getElementById('tab-link-tickets').addEventListener('click', () => showAnalystTab('tickets'));

            // Listeners dos links de navegação
            document.getElementById('nav-to-client-register').addEventListener('click', () => showScreen('client-register-screen'));
            document.getElementById('nav-to-employee-register').addEventListener('click', () => showScreen('employee-register-screen'));
            document.getElementById('nav-c-to-login').addEventListener('click', () => showScreen('login-screen'));
            document.getElementById('nav-e-to-login').addEventListener('click', () => showScreen('login-screen'));

            // Listeners dos botões de ação
            document.getElementById('logout-client').addEventListener('click', logout);
            document.getElementById('logout-employee').addEventListener('click', logout);
            document.getElementById('logout-chat').addEventListener('click', logout);
            document.getElementById('chat-btn-back').addEventListener('click', () => { currentChamadoId = null; const s = currentUserType === "Client" ? 'client-dashboard-screen' : 'employee-dashboard-screen'; showScreen(s); if (currentUserType === "Client") loadClientDashboard(); else loadEmployeeDashboard(); });
            document.getElementById('chat-btn-refresh').addEventListener('click', () => { if (currentChamadoId) { showMessage('Atualizando...', false); abrirChat(currentChamadoId); } });

            // --- CORREÇÃO 2: Event delegation para cliques nos grids (abrir chat) ---
            function handleGridClick(event) {
                // Verifica se o clique foi em uma célula clicável
                if (event.target && event.target.classList.contains('grid-clickable-cell')) {
                    // Encontra a linha (tr) pai e pega o data-id
                    const chamadoId = event.target.closest('tr').dataset.id;
                    if (chamadoId) abrirChat(chamadoId);
                }
            }
            document.getElementById('my-assigned-grid-body').addEventListener('click', handleGridClick);
            document.getElementById('analyst-ticket-grid-body').addEventListener('click', handleGridClick);
            document.getElementById('client-ticket-grid-body').addEventListener('click', handleGridClick);

            // --- CORREÇÃO 2: Event delegation para mudança de status ---
            function handleGridStatusChange(event) {
                if (event.target && event.target.classList.contains('status-select')) {
                    handleStatusChange(event.target);
                }
            }
            document.getElementById('my-assigned-grid-body').addEventListener('change', handleGridStatusChange);
            document.getElementById('analyst-ticket-grid-body').addEventListener('change', handleGridStatusChange);


            // Listeners de submit de formulário
            document.getElementById('chat-message-form').addEventListener('submit', async function (ev) {
                ev.preventDefault(); const i = document.getElementById('chat-message-input'); const c = i.value.trim(); if (!c || !currentChamadoId || !currentUserType) return; disableForm('chat-message-form', true); const ov = c; i.value = '';
                try {
                    const r = await fetchAutenticado(`${API_URL}/api/Chamado/${currentChamadoId}/mensagem`, { method: 'POST', body: JSON.stringify({ Conteudo: c, TipoRemetente: currentUserType }) }); if (!r.ok) { const ed = await r.json(); throw new Error(ed.message || `Erro ${r.status}.`); } const ms = await r.json(); renderizarMensagens(ms);
                } catch (e) { console.error(e); if (e.message !== "Sessão expirada.") showMessage(`Falha: ${e.message}`, true); i.value = ov; } finally { disableForm('chat-message-form', false); setTimeout(() => { try { i.focus(); } catch (e) { } }, 100); }
            });

            document.getElementById('btn-save-analyst-changes').addEventListener('click', async () => {
                if (!currentChamadoId || currentUserType !== 'Employee') return;
                disableForm('analyst-controls', true); const btn = document.getElementById('btn-save-analyst-changes'); const oTxt = btn.dataset.originalText || btn.textContent; btn.textContent = 'Salvando...';
                const s = document.getElementById('analyst-select-status').value; const p = document.getElementById('analyst-select-priority').value; const aidV = document.getElementById('analyst-select-assignee').value; const aid = aidV ? parseInt(aidV, 10) : null;
                const d = { Status: s, Prioridade: p, RoleDesignada: null, AnalistaId: aid }; // Role removida
                try {
                    const r = await fetchAutenticado(`${API_URL}/api/Chamado/${currentChamadoId}/atualizar`, { method: 'PUT', body: JSON.stringify(d) }); if (!r.ok) { const ed = await r.json(); throw new Error(ed.message || `Erro ${r.status}.`); } showMessage('Salvo!', false); abrirChat(currentChamadoId);
                } catch (e) { console.error(e); if (e.message !== "Sessão expirada.") showMessage(`Erro: ${e.message}`, true); } finally { disableForm('analyst-controls', false); btn.textContent = oTxt; }
            });

            document.getElementById('client-ticket-form').addEventListener('submit', async function (ev) {
                ev.preventDefault(); showMessage('', false); const iI = document.getElementById('ticket-imagens'); const imgs = iI.files; if (imgs.length > MAX_TOTAL_FILES) { showMessage(`Máx ${MAX_TOTAL_FILES} arquivos.`, true); iI.value = ''; return; } for (let i = 0; i < imgs.length; i++) { if (imgs[i].size > MAX_FILE_SIZE_MB * 1024 * 1024) { showMessage(`"${imgs[i].name}" > ${MAX_FILE_SIZE_MB}MB.`, true); iI.value = ''; return; } } disableForm('client-ticket-form', true); const fd = new FormData(); fd.append('Titulo', document.getElementById('ticket-titulo').value); fd.append('Descricao', document.getElementById('ticket-descricao').value); for (let i = 0; i < imgs.length; i++) { fd.append('Imagens', imgs[i]); }
                try {
                    const r = await fetchAutenticado(`${API_URL}/api/Chamado/criar`, { method: 'POST', body: fd }); if (r.status === 201) { const n = await r.json(); document.getElementById('client-ticket-form').reset(); abrirChat(n.id); } else { const err = await r.json(); throw new Error(err.message || `Erro ${r.status}.`); }
                } catch (e) { console.error(e); if (e.message !== "Sessão expirada.") showMessage(`Falha: ${e.message}`, true); } finally { disableForm('client-ticket-form', false); }
            });

            document.getElementById('login-form').addEventListener('submit', async function (event) {
                event.preventDefault(); // Garante que não recarrega
                showMessage('', false); disableForm('login-form', true); const d = { email: document.getElementById('login-email').value, password: document.getElementById('login-password').value };
                try {
                    const r = await fetch(`${API_URL}/api/Auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(d) });
                    const res = await r.json(); if (!r.ok) throw new Error(res.message || `Erro ${r.status}.`);
                    if (!res.token || !res.userName) throw new Error("Resposta de login incompleta.");
                    localStorage.setItem('jwtToken', res.token);
                    localStorage.setItem('userName', res.userName);
                    currentUserType = res.userType; document.getElementById('login-form').reset();
                    if (currentUserType === "Client") { showScreen('client-dashboard-screen'); loadClientDashboard(); }
                    else if (currentUserType === "Employee") { showScreen('employee-dashboard-screen'); loadEmployeeDashboard(); }
                    else { throw new Error('Tipo user desconhecido.'); }
                } catch (e) { console.error(e); showMessage(`Falha: ${e.message}`, true); } finally { disableForm('login-form', false); }
            });

            async function handleRegistration(fId, apiUrl) {
                const f = document.getElementById(fId); if (!f) return; showMessage('', false); disableForm(fId, true); const pI = f.querySelector('input[type="password"][id$="-password"]'); const cpI = f.querySelector('input[type="password"][id$="-confirm-password"]'); if (pI && cpI && pI.value !== cpI.value) { showMessage('Senhas não conferem.', true); disableForm(fId, false); return; } const vm = {};
                try {
                    if (fId === 'client-register-form') { vm.name = document.getElementById('client-name').value; vm.email = document.getElementById('client-email').value; vm.cpf = document.getElementById('client-cpf').value; vm.password = pI.value; vm.confirmPassword = cpI.value; }
                    else if (fId === 'employee-register-form') { vm.name = document.getElementById('employee-name').value; vm.email = document.getElementById('employee-email').value; vm.role = document.getElementById('employee-role').value; vm.password = pI.value; vm.confirmPassword = cpI.value; }
                    else { throw new Error("ID inválido."); }
                } catch (e) { showMessage("Erro lendo form.", true); console.error(e); disableForm(fId, false); return; }
                try { const r = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(vm) }); if (r.status === 201) { showMessage('Cadastrado! Faça login.', false); showScreen('login-screen'); f.reset(); } else { const err = await r.json(); if (err.errors) { const k = Object.keys(err.errors)[0]; showMessage(err.errors[k][0], true); } else { showMessage(err.message || `Erro ${r.status}.`, true); } } } catch (e) { console.error(`Erro (${fId}):`, e); showMessage('Não foi possível conectar.', true); } finally { disableForm(fId, false); }
            }
            document.getElementById('client-register-form').addEventListener('submit', (e) => { e.preventDefault(); handleRegistration('client-register-form', `${API_URL}/api/Registration/client`); });
            document.getElementById('employee-register-form').addEventListener('submit', (e) => { e.preventDefault(); handleRegistration('employee-register-form', `${API_URL}/api/Registration/employee`); });

            async function buscarSugestoesFaq() {
                const t = document.getElementById('ticket-titulo').value; const d = document.getElementById('ticket-descricao').value; const sC = document.getElementById('faq-sugestoes-container'); const sL = document.getElementById('faq-sugestoes-list'); if (!sC || !sL) return; sL.innerHTML = ''; sC.style.display = 'none'; if ((t.trim().length + d.trim().length) < 5) return;
                try { const r = await fetch(`${API_URL}/api/Faq/sugerir`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ Titulo: t, Descricao: d }) }); if (!r.ok) { console.error('Erro sugestões:', r.status); return; } const s = await r.json(); if (s && s.length > 0) { s.forEach(f => { const li = document.createElement('li'); const a = document.createElement('a'); a.href = '#'; a.textContent = f.pergunta; a.title = f.resposta; a.onclick = (e) => { e.preventDefault(); alert(`Resposta:\n\n${f.resposta}`); }; li.appendChild(a); sL.appendChild(li); }); sC.style.display = 'block'; } } catch (e) { console.error('Erro rede sugestões:', e); }
            }
            function debounceBuscarSugestoes() { clearTimeout(faqSuggestionTimeoutId); faqSuggestionTimeoutId = setTimeout(buscarSugestoesFaq, 750); }
            document.getElementById('ticket-titulo').addEventListener('input', debounceBuscarSugestoes);
            document.getElementById('ticket-descricao').addEventListener('input', debounceBuscarSugestoes);

            console.log("Portal NextLayer vFinal (Correção DOMContentLoaded) inicializado.");

        }); // --- FIM DO DOMContentLoaded ---
        /* --- FIM DO JAVASCRIPT --- */
    </script>

</body>
</html>